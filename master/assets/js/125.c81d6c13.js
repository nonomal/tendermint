(window.webpackJsonp=window.webpackJsonp||[]).push([[125],{674:function(e,a,t){"use strict";t.r(a);var n=t(1),o=Object(n.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"adr-062-p2p-architecture-and-abstractions"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#adr-062-p2p-architecture-and-abstractions"}},[e._v("#")]),e._v(" ADR 062: P2P Architecture and Abstractions")]),e._v(" "),t("h2",{attrs:{id:"changelog"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#changelog"}},[e._v("#")]),e._v(" Changelog")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("2020-11-09: Initial version (@erikgrinaker)")])]),e._v(" "),t("li",[t("p",[e._v("2020-11-13: Remove stream IDs, move peer errors onto channel, note on moving PEX into core (@erikgrinaker)")])]),e._v(" "),t("li",[t("p",[e._v("2020-11-16: Notes on recommended reactor implementation patterns, approve ADR (@erikgrinaker)")])])]),e._v(" "),t("h2",{attrs:{id:"context"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#context"}},[e._v("#")]),e._v(" Context")]),e._v(" "),t("p",[e._v("In "),t("RouterLink",{attrs:{to:"/architecture/adr-061-p2p-refactor-scope.html"}},[e._v("ADR 061")]),e._v(" we decided to refactor the peer-to-peer (P2P) networking stack. The first phase is to redesign and refactor the internal P2P architecture, while retaining protocol compatibility as far as possible.")],1),e._v(" "),t("h2",{attrs:{id:"alternative-approaches"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#alternative-approaches"}},[e._v("#")]),e._v(" Alternative Approaches")]),e._v(" "),t("p",[e._v("Several variations of the proposed design were considered, including e.g. calling interface methods instead of passing messages (like the current architecture), merging channels with streams, exposing the internal peer data structure to reactors, being message format-agnostic via arbitrary codecs, and so on. This design was chosen because it has very loose coupling, is simpler to reason about and more convenient to use, avoids race conditions and lock contention for internal data structures, gives reactors better control of message ordering and processing semantics, and allows for QoS scheduling and backpressure in a very natural way.")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://github.com/multiformats/multiaddr",target:"_blank",rel:"noopener noreferrer"}},[e._v("multiaddr"),t("OutboundLink")],1),e._v(" was considered as a transport-agnostic peer address format over regular URLs, but it does not appear to have very widespread adoption, and advanced features like protocol encapsulation and tunneling do not appear to be immediately useful to us.")]),e._v(" "),t("p",[e._v("There were also proposals to use LibP2P instead of maintaining our own P2P stack, which were rejected (for now) in "),t("RouterLink",{attrs:{to:"/architecture/adr-061-p2p-refactor-scope.html"}},[e._v("ADR 061")]),e._v(".")],1),e._v(" "),t("h2",{attrs:{id:"decision"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#decision"}},[e._v("#")]),e._v(" Decision")]),e._v(" "),t("p",[e._v("The P2P stack will be redesigned as a message-oriented architecture, primarily relying on Go channels for communication and scheduling. It will use IO stream transports to exchange raw bytes with individual peers, bidirectional peer-addressable channels to send and receive Protobuf messages, and a router to route messages between reactors and peers. Message passing is asynchronous with at-most-once delivery.")]),e._v(" "),t("h2",{attrs:{id:"detailed-design"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#detailed-design"}},[e._v("#")]),e._v(" Detailed Design")]),e._v(" "),t("p",[e._v("This ADR is primarily concerned with the architecture and interfaces of the P2P stack, not implementation details. Separate ADRs may be submitted for individual components, since implementation may be non-trivial. The interfaces described here should therefore be considered a rough architecture outline, not a complete and final design.")]),e._v(" "),t("p",[e._v("Primary design objectives have been:")]),e._v(" "),t("ul",[t("li",[e._v("Loose coupling between components, for a simpler, more robust, and test-friendly architecture.")]),e._v(" "),t("li",[e._v("Pluggable transports (not necessarily networked).")]),e._v(" "),t("li",[e._v("Better scheduling of messages, with improved prioritization, backpressure, and performance.")]),e._v(" "),t("li",[e._v("Centralized peer lifecycle and connection management.")]),e._v(" "),t("li",[e._v("Better peer address detection, advertisement, and exchange.")]),e._v(" "),t("li",[e._v("Wire-level backwards compatibility with current P2P network protocols, except where it proves too obstructive.")])]),e._v(" "),t("p",[e._v("The main abstractions in the new stack are:")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("peer")]),e._v(": A node in the network, uniquely identified by a "),t("code",[e._v("PeerID")]),e._v(" and stored in a "),t("code",[e._v("peerStore")]),e._v(".")]),e._v(" "),t("li",[t("code",[e._v("Transport")]),e._v(": An arbitrary mechanism to exchange bytes with a peer using IO "),t("code",[e._v("Stream")]),e._v("s across a "),t("code",[e._v("Connection")]),e._v(".")]),e._v(" "),t("li",[t("code",[e._v("Channel")]),e._v(": A bidirectional channel to asynchronously exchange Protobuf messages with peers addressed with "),t("code",[e._v("PeerID")]),e._v(".")]),e._v(" "),t("li",[t("code",[e._v("Router")]),e._v(": Maintains transport connections to relevant peers and routes channel messages.")]),e._v(" "),t("li",[e._v('Reactor: A design pattern loosely defined as "something which listens on a channel and reacts to messages".')])]),e._v(" "),t("p",[e._v("These abstractions are illustrated in the following diagram (representing the internals of node A) and described in detail below.")]),e._v(" "),t("p",[t("img",{attrs:{src:"img/adr-062-architecture.svg",alt:"P2P Architecture Diagram"}})]),e._v(" "),t("h3",{attrs:{id:"transports"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#transports"}},[e._v("#")]),e._v(" Transports")]),e._v(" "),t("p",[e._v("Transports are arbitrary mechanisms for exchanging raw bytes with a peer. For example, a gRPC transport would connect to a peer over TCP/IP and send data using the gRPC protocol, while an in-memory transport might communicate with a peer running in another goroutine using internal byte buffers. Note that transports don't have a notion of a "),t("code",[e._v("peer")]),e._v(" as such - instead, they communicate with an arbitrary endpoint address (e.g. IP address and port number), to decouple them from the rest of the P2P stack.")]),e._v(" "),t("p",[e._v("Transports must satisfy the following requirements:")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("Be connection-oriented, and support both listening for inbound connections and making outbound connections using endpoint addresses.")])]),e._v(" "),t("li",[t("p",[e._v("Support multiple logical IO streams within a single connection, to take full advantage of protocols with native stream support. For example, QUIC supports multiple independent streams, while HTTP/2 and MConn multiplex logical streams onto a single TCP connection.")])]),e._v(" "),t("li",[t("p",[e._v("Provide the public key of the peer, and possibly encrypt or sign the traffic as appropriate. This should be compared with known data (e.g. the peer ID) to authenticate the peer and avoid man-in-the-middle attacks.")])])]),e._v(" "),t("p",[e._v("The initial transport implementation will be a port of the current MConn protocol currently used by Tendermint, and should be backwards-compatible at the wire level as far as possible. This will be followed by an in-memory transport for testing, and a QUIC transport that may eventually replace MConn.")]),e._v(" "),t("p",[e._v("The "),t("code",[e._v("Transport")]),e._v(" interface is:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gVHJhbnNwb3J0IGlzIGFuIGFyYml0cmFyeSBtZWNoYW5pc20gZm9yIGV4Y2hhbmdpbmcgYnl0ZXMgd2l0aCBhIHBlZXIuCnR5cGUgVHJhbnNwb3J0IGludGVyZmFjZSB7CiAgICAvLyBBY2NlcHQgd2FpdHMgZm9yIHRoZSBuZXh0IGluYm91bmQgY29ubmVjdGlvbiBvbiBhIGxpc3RlbmluZyBlbmRwb2ludC4KICAgIEFjY2VwdChjb250ZXh0LkNvbnRleHQpIChDb25uZWN0aW9uLCBlcnJvcikKCiAgICAvLyBEaWFsIGNyZWF0ZXMgYW4gb3V0Ym91bmQgY29ubmVjdGlvbiB0byBhbiBlbmRwb2ludC4KICAgIERpYWwoY29udGV4dC5Db250ZXh0LCBFbmRwb2ludCkgKENvbm5lY3Rpb24sIGVycm9yKQoKICAgIC8vIEVuZHBvaW50cyBsaXN0cyBlbmRwb2ludHMgdGhlIHRyYW5zcG9ydCBpcyBsaXN0ZW5pbmcgb24uIEFueSBlbmRwb2ludCBJUAogICAgLy8gYWRkcmVzc2VzIGRvIG5vdCBuZWVkIHRvIGJlIG5vcm1hbGl6ZWQgaW4gYW55IHdheSAoZS5nLiAwLjAuMC4wIGlzCiAgICAvLyB2YWxpZCksIGFzIHRoZXkgc2hvdWxkIGJlIHByZXByb2Nlc3NlZCBiZWZvcmUgYmVpbmcgYWR2ZXJ0aXNlZC4KICAgIEVuZHBvaW50cygpIFtdRW5kcG9pbnQKfQo="}}),e._v(" "),t("p",[e._v("How the transport configures listening is transport-dependent, and not covered by the interface. This typically happens during transport construction, where a single instance of the transport is created and set to listen on an appropriate network interface before being passed to the router.")]),e._v(" "),t("h4",{attrs:{id:"endpoints"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#endpoints"}},[e._v("#")]),e._v(" Endpoints")]),e._v(" "),t("p",[t("code",[e._v("Endpoint")]),e._v(" represents a transport endpoint (e.g. an IP address and port). A connection always has two endpoints: one at the local node and one at the remote peer. Outbound connections to remote endpoints are made via "),t("code",[e._v("Dial()")]),e._v(", and inbound connections to listening endpoints are returned via "),t("code",[e._v("Accept()")]),e._v(".")]),e._v(" "),t("p",[e._v("The "),t("code",[e._v("Endpoint")]),e._v(" struct is:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gRW5kcG9pbnQgcmVwcmVzZW50cyBhIHRyYW5zcG9ydCBjb25uZWN0aW9uIGVuZHBvaW50LCBlaXRoZXIgbG9jYWwgb3IgcmVtb3RlLgp0eXBlIEVuZHBvaW50IHN0cnVjdCB7CiAgICAvLyBQcm90b2NvbCBzcGVjaWZpZXMgdGhlIHRyYW5zcG9ydCBwcm90b2NvbCwgdXNlZCBieSB0aGUgcm91dGVyIHRvIHBpY2sgYQogICAgLy8gdHJhbnNwb3J0IGZvciBhbiBlbmRwb2ludC4KICAgIFByb3RvY29sIFByb3RvY29sCgogICAgLy8gUGF0aCBpcyBhbiBvcHRpb25hbCwgYXJiaXRyYXJ5IHRyYW5zcG9ydC1zcGVjaWZpYyBwYXRoIG9yIGlkZW50aWZpZXIuCiAgICBQYXRoIHN0cmluZwoKICAgIC8vIElQIGlzIGFuIElQIGFkZHJlc3MgKHY0IG9yIHY2KSB0byBjb25uZWN0IHRvLiBJZiBzZXQsIHRoaXMgZGVmaW5lcyB0aGUKICAgIC8vIGVuZHBvaW50IGFzIGEgbmV0d29ya2VkIGVuZHBvaW50LgogICAgSVAgbmV0LklQCgogICAgLy8gUG9ydCBpcyBhIG5ldHdvcmsgcG9ydCAoZWl0aGVyIFRDUCBvciBVRFApLiBJZiBub3Qgc2V0LCBhIGRlZmF1bHQgcG9ydAogICAgLy8gbWF5IGJlIHVzZWQgZGVwZW5kaW5nIG9uIHRoZSBwcm90b2NvbC4KICAgIFBvcnQgdWludDE2Cn0KCi8vIFByb3RvY29sIGlkZW50aWZpZXMgYSB0cmFuc3BvcnQgcHJvdG9jb2wuCnR5cGUgUHJvdG9jb2wgc3RyaW5nCg=="}}),e._v(" "),t("p",[e._v("Endpoints are arbitrary transport-specific addresses, but if they are networked they must use IP addresses and thus rely on IP as a fundamental packet routing protocol. This enables policies for address discovery, advertisement, and exchange - for example, a private "),t("code",[e._v("192.168.0.0/24")]),e._v(" IP address should only be advertised to peers on that IP network, while the public address "),t("code",[e._v("8.8.8.8")]),e._v(" may be advertised to all peers. Similarly, any port numbers if given must represent TCP and/or UDP port numbers, in order to use "),t("a",{attrs:{href:"https://en.wikipedia.org/wiki/Universal_Plug_and_Play",target:"_blank",rel:"noopener noreferrer"}},[e._v("UPnP"),t("OutboundLink")],1),e._v(" to autoconfigure e.g. NAT gateways.")]),e._v(" "),t("p",[e._v("Non-networked endpoints (without an IP address) are considered local, and will only be advertised to other peers connecting via the same protocol. For example, an in-memory transport used for testing might have "),t("code",[e._v('Endpoint{Protocol: "memory", Path: "foo"}')]),e._v(' as an address for the node "foo", and this should only be advertised to other nodes using '),t("code",[e._v('Protocol: "memory"')]),e._v(".")]),e._v(" "),t("h4",{attrs:{id:"connections-and-streams"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#connections-and-streams"}},[e._v("#")]),e._v(" Connections and Streams")]),e._v(" "),t("p",[e._v("A connection represents an established transport connection between two endpoints (and thus two nodes), which can be used to exchange bytes via logically distinct IO streams. Connections are set up either via "),t("code",[e._v("Transport.Dial()")]),e._v(" (outbound) or "),t("code",[e._v("Transport.Accept()")]),e._v(" (inbound). The caller is responsible for verifying the remote peer's public key as returned by the connection, following the current MConn protocol behavior for now.")]),e._v(" "),t("p",[e._v("Data is exchanged over IO streams created with "),t("code",[e._v("Connection.Stream()")]),e._v(". These implement the standard Go "),t("code",[e._v("io.Reader")]),e._v(" and "),t("code",[e._v("io.Writer")]),e._v(" interfaces to read and write bytes. Transports are free to choose how to implement such streams, e.g. by taking advantage of native stream support in the underlying protocol or through multiplexing.")]),e._v(" "),t("p",[t("code",[e._v("Connection")]),e._v(" and the related "),t("code",[e._v("Stream")]),e._v(" interfaces are:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gQ29ubmVjdGlvbiByZXByZXNlbnRzIGFuIGVzdGFibGlzaGVkIGNvbm5lY3Rpb24gYmV0d2VlbiB0d28gZW5kcG9pbnRzLgp0eXBlIENvbm5lY3Rpb24gaW50ZXJmYWNlIHsKICAgIC8vIFN0cmVhbSBjcmVhdGVzIGEgbmV3IGxvZ2ljYWxseSBkaXN0aW5jdCBJTyBzdHJlYW0gd2l0aGluIHRoZSBjb25uZWN0aW9uLgogICAgU3RyZWFtKCkgKFN0cmVhbSwgZXJyb3IpCgogICAgLy8gTG9jYWxFbmRwb2ludCByZXR1cm5zIHRoZSBsb2NhbCBlbmRwb2ludCBmb3IgdGhlIGNvbm5lY3Rpb24uCiAgICBMb2NhbEVuZHBvaW50KCkgRW5kcG9pbnQKCiAgICAvLyBSZW1vdGVFbmRwb2ludCByZXR1cm5zIHRoZSByZW1vdGUgZW5kcG9pbnQgZm9yIHRoZSBjb25uZWN0aW9uLgogICAgUmVtb3RlRW5kcG9pbnQoKSBFbmRwb2ludAoKICAgIC8vIFB1YktleSByZXR1cm5zIHRoZSBwdWJsaWMga2V5IG9mIHRoZSByZW1vdGUgcGVlci4KICAgIFB1YktleSgpIGNyeXB0by5QdWJLZXkKCiAgICAvLyBDbG9zZSBjbG9zZXMgdGhlIGNvbm5lY3Rpb24uCiAgICBDbG9zZSgpIGVycm9yCn0KCi8vIFN0cmVhbSByZXByZXNlbnRzIGEgc2luZ2xlIGxvZ2ljYWwgSU8gc3RyZWFtIHdpdGhpbiBhIGNvbm5lY3Rpb24uCnR5cGUgU3RyZWFtIGludGVyZmFjZSB7CiAgICBpby5SZWFkZXIgLy8gUmVhZChbXWJ5dGUpIChpbnQsIGVycm9yKQogICAgaW8uV3JpdGVyIC8vIFdyaXRlKFtdYnl0ZSkgKGludCwgZXJyb3IpCiAgICBpby5DbG9zZXIgLy8gQ2xvc2UoKSBlcnJvcgp9Cg=="}}),e._v(" "),t("h3",{attrs:{id:"peers"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#peers"}},[e._v("#")]),e._v(" Peers")]),e._v(" "),t("p",[e._v("Peers are other Tendermint network nodes. Each peer is identified by a unique "),t("code",[e._v("PeerID")]),e._v(", and has a set of "),t("code",[e._v("PeerAddress")]),e._v(" addresses expressed as URLs that they can be reached at. Examples of peer addresses might be e.g.:")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("mconn://b10c@host.domain.com:25567/path")])]),e._v(" "),t("li",[t("code",[e._v("unix:///var/run/tendermint/peer.sock")])]),e._v(" "),t("li",[t("code",[e._v("memory:testpeer")])])]),e._v(" "),t("p",[e._v("Addresses are resolved into one or more transport endpoints, e.g. by resolving DNS hostnames into IP addresses (which should be refreshed periodically). Peers should always be expressed as address URLs, and never as endpoints which are a lower-level construct.")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gUGVlcklEIGlzIGEgdW5pcXVlIHBlZXIgSUQsIGdlbmVyYWxseSBleHByZXNzZWQgaW4gaGV4IGZvcm0uCnR5cGUgUGVlcklEIFtdYnl0ZQoKLy8gUGVlckFkZHJlc3MgaXMgYSBwZWVyIGFkZHJlc3MgVVJMLiBUaGUgVXNlciBmaWVsZCwgaWYgc2V0LCBnaXZlcyB0aGUKLy8gaGV4LWVuY29kZWQgcmVtb3RlIFBlZXJJRCwgd2hpY2ggc2hvdWxkIGJlIHZlcmlmaWVkIHdpdGggdGhlIHJlbW90ZSBwZWVyJ3MKLy8gcHVibGljIGtleSBhcyByZXR1cm5lZCBieSB0aGUgY29ubmVjdGlvbi4KdHlwZSBQZWVyQWRkcmVzcyB1cmwuVVJMCgovLyBSZXNvbHZlIHJlc29sdmVzIGEgUGVlckFkZHJlc3MgaW50byBhIHNldCBvZiBFbmRwb2ludHMsIHR5cGljYWxseSBieQovLyBleHBhbmRpbmcgb3V0IGEgRE5TIG5hbWUgaW4gSG9zdCB0byBpdHMgSVAgYWRkcmVzc2VzLiBGaWVsZCBtYXBwaW5nOgovLwovLyAgIFNjaGVtZSDihpIgRW5kcG9pbnQuUHJvdG9jb2wKLy8gICBIb3N0ICAg4oaSIEVuZHBvaW50LklQCi8vICAgUG9ydCAgIOKGkiBFbmRwb2ludC5Qb3J0Ci8vICAgUGF0aCtRdWVyeStGcmFnbWVudCxPcGFxdWUg4oaSIEVuZHBvaW50LlBhdGgKLy8KZnVuYyAoYSBQZWVyQWRkcmVzcykgUmVzb2x2ZShjdHggY29udGV4dC5Db250ZXh0KSBbXUVuZHBvaW50IHsgcmV0dXJuIG5pbCB9Cg=="}}),e._v(" "),t("p",[e._v("The P2P stack needs to track a lot of internal information about peers, such as endpoints, status, priorities, and so on. This is done in an internal "),t("code",[e._v("peer")]),e._v(" struct, which should not be exposed outside of the "),t("code",[e._v("p2p")]),e._v(" package (e.g. to reactors) in order to avoid race conditions and lock contention - other packages should use "),t("code",[e._v("PeerID")]),e._v(".")]),e._v(" "),t("p",[e._v("The "),t("code",[e._v("peer")]),e._v(" struct might look like the following, but is intentionally underspecified and will depend on implementation requirements (for example, it will almost certainly have to track statistics about connection failures and retries):")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gcGVlciB0cmFja3MgaW50ZXJuYWwgc3RhdHVzIGluZm9ybWF0aW9uIGFib3V0IGEgcGVlci4KdHlwZSBwZWVyIHN0cnVjdCB7CiAgICBJRCAgICAgICAgUGVlcklECiAgICBTdGF0dXMgICAgUGVlclN0YXR1cwogICAgUHJpb3JpdHkgIFBlZXJQcmlvcml0eQogICAgRW5kcG9pbnRzIG1hcFtQZWVyQWRkcmVzc11bXUVuZHBvaW50IC8vIFJlc29sdmVkIGVuZHBvaW50cyBieSBhZGRyZXNzLgp9CgovLyBQZWVyU3RhdHVzIHNwZWNpZmllcyBwZWVyIHN0YXR1c2VzLgp0eXBlIFBlZXJTdGF0dXMgc3RyaW5nCgpjb25zdCAoCiAgICBQZWVyU3RhdHVzTmV3ICAgICA9ICZxdW90O25ldyZxdW90OyAgICAgLy8gTmV3IHBlZXIgd2hpY2ggd2UgaGF2ZW4ndCB0cmllZCB0byBjb250YWN0IHlldC4KICAgIFBlZXJTdGF0dXNVcCAgICAgID0gJnF1b3Q7dXAmcXVvdDsgICAgICAvLyBQZWVyIHdoaWNoIHdlIGhhdmUgYW4gYWN0aXZlIGNvbm5lY3Rpb24gdG8uCiAgICBQZWVyU3RhdHVzRG93biAgICA9ICZxdW90O2Rvd24mcXVvdDsgICAgLy8gUGVlciB3aGljaCB3ZSdyZSB0ZW1wb3JhcmlseSBkaXNjb25uZWN0ZWQgZnJvbS4KICAgIFBlZXJTdGF0dXNSZW1vdmVkID0gJnF1b3Q7cmVtb3ZlZCZxdW90OyAvLyBQZWVyIHdoaWNoIGhhcyBiZWVuIHJlbW92ZWQuCiAgICBQZWVyU3RhdHVzQmFubmVkICA9ICZxdW90O2Jhbm5lZCZxdW90OyAgLy8gUGVlciB3aGljaCBpcyBiYW5uZWQgZm9yIG1pc2JlaGF2aW9yLgopCgovLyBQZWVyUHJpb3JpdHkgc3BlY2lmaWVzIHBlZXIgcHJpb3JpdGllcy4KdHlwZSBQZWVyUHJpb3JpdHkgaW50Cgpjb25zdCAoCiAgICBQZWVyUHJpb3JpdHlOb3JtYWwgUGVlclByaW9yaXR5ID0gaW90YSArIDEKICAgIFBlZXJQcmlvcml0eVZhbGlkYXRvcgogICAgUGVlclByaW9yaXR5UGVyc2lzdGVudAopCg=="}}),e._v(" "),t("p",[e._v("Peer information is stored in a "),t("code",[e._v("peerStore")]),e._v(", which may be persisted in an underlying database, and will replace the current address book either partially or in full. It is kept internal to avoid race conditions and tight coupling, and should at the very least contain basic CRUD functionality as outlined below, but will likely need additional functionality and is intentionally underspecified:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gcGVlclN0b3JlIGNvbnRhaW5zIGluZm9ybWF0aW9uIGFib3V0IHBlZXJzLCBwb3NzaWJseSBwZXJzaXN0ZWQgdG8gZGlzay4KdHlwZSBwZWVyU3RvcmUgc3RydWN0IHsKICAgIHBlZXJzIG1hcFtzdHJpbmddKnBlZXIgLy8gRW50aXJlIHNldCBpbiBtZW1vcnksIHdpdGggUGVlcklELlN0cmluZygpIGtleXMuCiAgICBkYiAgICBkYm0uREIgICAgICAgICAgIC8vIERhdGFiYXNlIGZvciBwZXJzaXN0ZW5jZSwgaWYgbm9uLW5pbC4KfQoKZnVuYyAocCAqcGVlclN0b3JlKSBEZWxldGUoaWQgUGVlcklEKSBlcnJvciAgICAgeyByZXR1cm4gbmlsIH0KZnVuYyAocCAqcGVlclN0b3JlKSBHZXQoaWQgUGVlcklEKSAocGVlciwgYm9vbCkgeyByZXR1cm4gcGVlcnt9LCBmYWxzZSB9CmZ1bmMgKHAgKnBlZXJTdG9yZSkgTGlzdCgpIFtdcGVlciAgICAgICAgICAgICAgIHsgcmV0dXJuIG5pbCB9CmZ1bmMgKHAgKnBlZXJTdG9yZSkgU2V0KHBlZXIgcGVlcikgZXJyb3IgICAgICAgIHsgcmV0dXJuIG5pbCB9Cg=="}}),e._v(" "),t("p",[e._v("Peer address detection, advertisement and exchange (including detection of externally-reachable addresses via e.g. NAT gateways) is out of scope for this ADR, but may be covered in a separate ADR. The current PEX reactor should probably be absorbed into the core P2P stack and protocol instead of running as a separate reactor, since this needs to mutate the core peer data structures and will thus be tightly coupled with the router.")]),e._v(" "),t("h3",{attrs:{id:"channels"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#channels"}},[e._v("#")]),e._v(" Channels")]),e._v(" "),t("p",[e._v("While low-level data exchange happens via transport IO streams, the high-level API is based on a bidirectional "),t("code",[e._v("Channel")]),e._v(" that can send and receive Protobuf messages addressed by "),t("code",[e._v("PeerID")]),e._v(". A channel is identified by an arbitrary "),t("code",[e._v("ChannelID")]),e._v(" identifier, and can exchange Protobuf messages of one specific type (since the type to unmarshal into must be known). Message delivery is asynchronous and at-most-once.")]),e._v(" "),t("p",[e._v("The channel can also be used to report peer errors, e.g. when receiving an invalid or malignant message. This may cause the peer to be disconnected or banned depending on the router's policy.")]),e._v(" "),t("p",[e._v("A "),t("code",[e._v("Channel")]),e._v(" has this interface:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gQ2hhbm5lbCBpcyBhIGJpZGlyZWN0aW9uYWwgY2hhbm5lbCBmb3IgUHJvdG9idWYgbWVzc2FnZSBleGNoYW5nZSB3aXRoIHBlZXJzLgp0eXBlIENoYW5uZWwgc3RydWN0IHsKICAgIC8vIElEIGNvbnRhaW5zIHRoZSBjaGFubmVsIElELgogICAgSUQgQ2hhbm5lbElECgogICAgLy8gbWVzc2FnZVR5cGUgc3BlY2lmaWVzIHRoZSB0eXBlIG9mIG1lc3NhZ2VzIGV4Y2hhbmdlZCB2aWEgdGhlIGNoYW5uZWwsIGFuZAogICAgLy8gaXMgdXNlZCBlLmcuIGZvciBhdXRvbWF0aWMgdW5tYXJzaGFsaW5nLgogICAgbWVzc2FnZVR5cGUgcHJvdG8uTWVzc2FnZQoKICAgIC8vIEluIGlzIGEgY2hhbm5lbCBmb3IgcmVjZWl2aW5nIGluYm91bmQgbWVzc2FnZXMuIEVudmVsb3BlLkZyb20gaXMgYWx3YXlzCiAgICAvLyBzZXQuCiAgICBJbiAmbHQ7LWNoYW4gRW52ZWxvcGUKCiAgICAvLyBPdXQgaXMgYSBjaGFubmVsIGZvciBzZW5kaW5nIG91dGJvdW5kIG1lc3NhZ2VzLiBFbnZlbG9wZS5UbyBvciBCcm9hZGNhc3QKICAgIC8vIG11c3QgYmUgc2V0LCBvdGhlcndpc2UgdGhlIG1lc3NhZ2UgaXMgZGlzY2FyZGVkLgogICAgT3V0IGNoYW4mbHQ7LSBFbnZlbG9wZQoKICAgIC8vIEVycm9yIGlzIGEgY2hhbm5lbCBmb3IgcmVwb3J0aW5nIHBlZXIgZXJyb3JzIHRvIHRoZSByb3V0ZXIsIHR5cGljYWxseSB1c2VkCiAgICAvLyB3aGVuIHBlZXJzIHNlbmQgYW4gaW52YWxpZCBvciBtYWxpZ25hbnQgbWVzc2FnZS4KICAgIEVycm9yIGNoYW4mbHQ7LSBQZWVyRXJyb3IKfQoKLy8gQ2xvc2UgY2xvc2VzIHRoZSBjaGFubmVsLCBhbmQgaXMgZXF1aXZhbGVudCB0byBjbG9zZShDaGFubmVsLk91dCkuIFRoaXMgd2lsbAovLyBjYXVzZSBDaGFubmVsLkluIHRvIGJlIGNsb3NlZCB3aGVuIGFwcHJvcHJpYXRlLiBUaGUgSUQgY2FuIHRoZW4gYmUgcmV1c2VkLgpmdW5jIChjICpDaGFubmVsKSBDbG9zZSgpIGVycm9yIHsgcmV0dXJuIG5pbCB9CgovLyBDaGFubmVsSUQgaXMgYW4gYXJiaXRyYXJ5IGNoYW5uZWwgSUQuCnR5cGUgQ2hhbm5lbElEIHVpbnQxNgoKLy8gRW52ZWxvcGUgc3BlY2lmaWVzIHRoZSBtZXNzYWdlIHJlY2VpdmVyIGFuZCBzZW5kZXIuCnR5cGUgRW52ZWxvcGUgc3RydWN0IHsKICAgIEZyb20gICAgICBQZWVySUQgICAgICAgIC8vIE1lc3NhZ2Ugc2VuZGVyLCBvciBlbXB0eSBmb3Igb3V0Ym91bmQgbWVzc2FnZXMuCiAgICBUbyAgICAgICAgUGVlcklEICAgICAgICAvLyBNZXNzYWdlIHJlY2VpdmVyLCBvciBlbXB0eSBmb3IgaW5ib3VuZCBtZXNzYWdlcy4KICAgIEJyb2FkY2FzdCBib29sICAgICAgICAgIC8vIFNlbmQgbWVzc2FnZSB0byBhbGwgY29ubmVjdGVkIHBlZXJzLCBpZ25vcmluZyBUby4KICAgIE1lc3NhZ2UgICBwcm90by5NZXNzYWdlIC8vIFBheWxvYWQuCn0KCi8vIFBlZXJFcnJvciBpcyBhIHBlZXIgZXJyb3IgcmVwb3J0ZWQgYnkgYSByZWFjdG9yIHZpYSB0aGUgRXJyb3IgY2hhbm5lbC4gVGhlCi8vIHNldmVyaXR5IG1heSBjYXVzZSB0aGUgcGVlciB0byBiZSBkaXNjb25uZWN0ZWQgb3IgYmFubmVkIGRlcGVuZGluZyBvbiBwb2xpY3kuCnR5cGUgUGVlckVycm9yIHN0cnVjdCB7CiAgICBQZWVySUQgICBQZWVySUQKICAgIEVyciAgICAgIGVycm9yCiAgICBTZXZlcml0eSBQZWVyRXJyb3JTZXZlcml0eQp9CgovLyBQZWVyRXJyb3JTZXZlcml0eSBkZXRlcm1pbmVzIHRoZSBzZXZlcml0eSBvZiBhIHBlZXIgZXJyb3IuCnR5cGUgUGVlckVycm9yU2V2ZXJpdHkgc3RyaW5nCgpjb25zdCAoCiAgICBQZWVyRXJyb3JTZXZlcml0eUxvdyAgICAgIFBlZXJFcnJvclNldmVyaXR5ID0gJnF1b3Q7bG93JnF1b3Q7ICAgICAgLy8gTW9zdGx5IGlnbm9yZWQuCiAgICBQZWVyRXJyb3JTZXZlcml0eUhpZ2ggICAgIFBlZXJFcnJvclNldmVyaXR5ID0gJnF1b3Q7aGlnaCZxdW90OyAgICAgLy8gTWF5IGRpc2Nvbm5lY3QuCiAgICBQZWVyRXJyb3JTZXZlcml0eUNyaXRpY2FsIFBlZXJFcnJvclNldmVyaXR5ID0gJnF1b3Q7Y3JpdGljYWwmcXVvdDsgLy8gQmFuLgopCg=="}}),e._v(" "),t("p",[e._v("A channel can reach any connected peer, and is implemented using transport streams against each individual peer, with an initial handshake to exchange the channel ID and any other metadata. The channel will automatically (un)marshal Protobuf to byte slices and use length-prefixed framing (the de facto standard for Protobuf streams) when writing them to the stream.")]),e._v(" "),t("p",[e._v("Message scheduling and queueing is left as an implementation detail, and can use any number of algorithms such as FIFO, round-robin, priority queues, etc. Since message delivery is not guaranteed, both inbound and outbound messages may be dropped, buffered, or blocked as appropriate.")]),e._v(" "),t("p",[e._v("Since a channel can only exchange messages of a single type, it is often useful to use a wrapper message type with e.g. a Protobuf "),t("code",[e._v("oneof")]),e._v(" field that specifies a set of inner message types that it can contain. The channel can automatically perform this (un)wrapping if the outer message type implements the "),t("code",[e._v("Wrapper")]),e._v(" interface (see "),t("a",{attrs:{href:"#reactor-example"}},[e._v("Reactor Example")]),e._v(" for an example):")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gV3JhcHBlciBpcyBhIFByb3RvYnVmIG1lc3NhZ2UgdGhhdCBjYW4gY29udGFpbiBhIHZhcmlldHkgb2YgaW5uZXIgbWVzc2FnZXMuCi8vIElmIGEgQ2hhbm5lbCdzIG1lc3NhZ2UgdHlwZSBpbXBsZW1lbnRzIFdyYXBwZXIsIHRoZSBjaGFubmVsIHdpbGwKLy8gYXV0b21hdGljYWxseSAodW4pd3JhcCBwYXNzZWQgbWVzc2FnZXMgdXNpbmcgdGhlIGNvbnRhaW5lciB0eXBlLCBzdWNoIHRoYXQKLy8gdGhlIGNoYW5uZWwgY2FuIHRyYW5zcGFyZW50bHkgc3VwcG9ydCBtdWx0aXBsZSBtZXNzYWdlIHR5cGVzLgp0eXBlIFdyYXBwZXIgaW50ZXJmYWNlIHsKICAgIC8vIFdyYXAgd2lsbCB0YWtlIGEgbWVzc2FnZSBhbmQgd3JhcCBpdCBpbiB0aGlzIG9uZS4KICAgIFdyYXAocHJvdG8uTWVzc2FnZSkgZXJyb3IKCiAgICAvLyBVbndyYXAgd2lsbCB1bndyYXAgdGhlIGlubmVyIG1lc3NhZ2UgY29udGFpbmVkIGluIHRoaXMgbWVzc2FnZS4KICAgIFVud3JhcCgpIChwcm90by5NZXNzYWdlLCBlcnJvcikKfQo="}}),e._v(" "),t("h3",{attrs:{id:"routers"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#routers"}},[e._v("#")]),e._v(" Routers")]),e._v(" "),t("p",[e._v("The router manages all P2P networking for a node, and is responsible for keeping track of network peers, maintaining transport connections, and routing channel messages. As such, it must do e.g. connection retries and backoff, message QoS scheduling and backpressure, peer quality assessments, and endpoint detection and advertisement. In addition, the router provides a mechanism to subscribe to peer updates (e.g. peers connecting or disconnecting), and handles reported peer errors from reactors.")]),e._v(" "),t("p",[e._v("The implementation of the router is likely to be non-trivial, and is intentionally unspecified here. A separate ADR will likely be submitted for this. It is unclear whether message routing/scheduling and peer lifecycle management can be split into two separate components, or if these need to be tightly coupled.")]),e._v(" "),t("p",[e._v("The "),t("code",[e._v("Router")]),e._v(" API is as follows:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gUm91dGVyIG1hbmFnZXMgY29ubmVjdGlvbnMgdG8gcGVlcnMgYW5kIHJvdXRlcyBQcm90b2J1ZiBtZXNzYWdlcyBiZXR3ZWVuIHRoZW0KLy8gYW5kIGxvY2FsIHJlYWN0b3JzLiBJdCBhbHNvIHByb3ZpZGVzIHBlZXIgc3RhdHVzIHVwZGF0ZXMgYW5kIGVycm9yIHJlcG9ydGluZy4KdHlwZSBSb3V0ZXIgc3RydWN0e30KCi8vIE5ld1JvdXRlciBjcmVhdGVzIGEgbmV3IHJvdXRlciwgdXNpbmcgdGhlIGdpdmVuIHBlZXIgc3RvcmUgdG8gdHJhY2sgcGVlcnMuCi8vIFRyYW5zcG9ydHMgbXVzdCBiZSBwcmUtaW5pdGlhbGl6ZWQgdG8gbGlzdGVuIG9uIGFwcHJvcHJpYXRlIGVuZHBvaW50cy4KZnVuYyBOZXdSb3V0ZXIocGVlclN0b3JlICpwZWVyU3RvcmUsIHRyYW5zcG9ydHMgbWFwW1Byb3RvY29sXVRyYW5zcG9ydCkgKlJvdXRlciB7IHJldHVybiBuaWwgfQoKLy8gQ2hhbm5lbCBvcGVucyBhIG5ldyBjaGFubmVsIHdpdGggdGhlIGdpdmVuIElELiBtZXNzYWdlVHlwZSBzaG91bGQgYmUgYW4gZW1wdHkKLy8gUHJvdG9idWYgbWVzc2FnZSBvZiB0aGUgdHlwZSB0aGF0IHdpbGwgYmUgcGFzc2VkIHRocm91Z2ggdGhlIGNoYW5uZWwuIFRoZQovLyBtZXNzYWdlIGNhbiBpbXBsZW1lbnQgV3JhcHBlciBmb3IgYXV0b21hdGljIG1lc3NhZ2UgKHVuKXdyYXBwaW5nLgpmdW5jIChyICpSb3V0ZXIpIENoYW5uZWwoaWQgQ2hhbm5lbElELCBtZXNzYWdlVHlwZSBwcm90by5NZXNzYWdlKSAoKkNoYW5uZWwsIGVycm9yKSB7IHJldHVybiBuaWwsIG5pbCB9CgovLyBQZWVyVXBkYXRlcyByZXR1cm5zIGEgY2hhbm5lbCB3aXRoIHBlZXIgdXBkYXRlcy4gVGhlIGNhbGxlciBtdXN0IGNhbmNlbCB0aGUKLy8gY29udGV4dCB0byBlbmQgdGhlIHN1YnNjcmlwdGlvbiwgYW5kIGtlZXAgY29uc3VtaW5nIG1lc3NhZ2VzIGluIGEgdGltZWx5Ci8vIGZhc2hpb24gdW50aWwgdGhlIGNoYW5uZWwgaXMgY2xvc2VkIHRvIGF2b2lkIGJsb2NraW5nIHVwZGF0ZXMuCmZ1bmMgKHIgKlJvdXRlcikgUGVlclVwZGF0ZXMoY3R4IGNvbnRleHQuQ29udGV4dCkgUGVlclVwZGF0ZXMgeyByZXR1cm4gbmlsIH0KCi8vIFBlZXJVcGRhdGVzIGlzIGEgY2hhbm5lbCBmb3IgcmVjZWl2aW5nIHBlZXIgdXBkYXRlcy4KdHlwZSBQZWVyVXBkYXRlcyAmbHQ7LWNoYW4gUGVlclVwZGF0ZQoKLy8gUGVlclVwZGF0ZSBpcyBhIHBlZXIgc3RhdHVzIHVwZGF0ZSBmb3IgcmVhY3RvcnMuCnR5cGUgUGVlclVwZGF0ZSBzdHJ1Y3QgewogICAgUGVlcklEIFBlZXJJRAogICAgU3RhdHVzIFBlZXJTdGF0dXMKfQo="}}),e._v(" "),t("h3",{attrs:{id:"reactor-example"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#reactor-example"}},[e._v("#")]),e._v(" Reactor Example")]),e._v(" "),t("p",[e._v("While reactors are a first-class concept in the current P2P stack (i.e. there is an explicit "),t("code",[e._v("p2p.Reactor")]),e._v(' interface), they will simply be a design pattern in the new stack, loosely defined as "something which listens on a channel and reacts to messages".')]),e._v(" "),t("p",[e._v("Since reactors have very few formal constraints, they can be implemented in a variety of ways. There is currently no recommended pattern for implementing reactors, to avoid overspecification and scope creep in this ADR. However, prototyping and developing a reactor pattern should be done early during implementation, to make sure reactors built using the "),t("code",[e._v("Channel")]),e._v(" interface can satisfy the needs for convenience, deterministic tests, and reliability.")]),e._v(" "),t("p",[e._v("Below is a trivial example of a simple echo reactor implemented as a function. The reactor will exchange the following Protobuf messages:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"protobuf",base64:"bWVzc2FnZSBFY2hvTWVzc2FnZSB7CiAgICBvbmVvZiBpbm5lciB7CiAgICAgICAgUGluZ01lc3NhZ2UgcGluZyA9IDE7CiAgICAgICAgUG9uZ01lc3NhZ2UgcG9uZyA9IDI7CiAgICB9Cn0KCm1lc3NhZ2UgUGluZ01lc3NhZ2UgewogICAgc3RyaW5nIGNvbnRlbnQgPSAxOwp9CgptZXNzYWdlIFBvbmdNZXNzYWdlIHsKICAgIHN0cmluZyBjb250ZW50ID0gMTsKfQo="}}),e._v(" "),t("p",[e._v("Implementing the "),t("code",[e._v("Wrapper")]),e._v(" interface for "),t("code",[e._v("EchoMessage")]),e._v(" allows transparently passing "),t("code",[e._v("PingMessage")]),e._v(" and "),t("code",[e._v("PongMessage")]),e._v(" through the channel, where it will automatically be (un)wrapped in an "),t("code",[e._v("EchoMessage")]),e._v(":")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAobSAqRWNob01lc3NhZ2UpIFdyYXAoaW5uZXIgcHJvdG8uTWVzc2FnZSkgZXJyb3IgewogICAgc3dpdGNoIGlubmVyIDo9IGlubmVyLih0eXBlKSB7CiAgICBjYXNlICpQaW5nTWVzc2FnZToKICAgICAgICBtLklubmVyID0gJmFtcDtFY2hvTWVzc2FnZV9QaW5nTWVzc2FnZXtQaW5nOiBpbm5lcn0KICAgIGNhc2UgKlBvbmdNZXNzYWdlOgogICAgICAgIG0uSW5uZXIgPSAmYW1wO0VjaG9NZXNzYWdlX1BvbmdNZXNzYWdle1Bvbmc6IGlubmVyfQogICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gZm10LkVycm9yZigmcXVvdDt1bmtub3duIG1lc3NhZ2UgJVQmcXVvdDssIGlubmVyKQogICAgfQogICAgcmV0dXJuIG5pbAp9CgpmdW5jIChtICpFY2hvTWVzc2FnZSkgVW53cmFwKCkgKHByb3RvLk1lc3NhZ2UsIGVycm9yKSB7CiAgICBzd2l0Y2ggaW5uZXIgOj0gbS5Jbm5lci4odHlwZSkgewogICAgY2FzZSAqRWNob01lc3NhZ2VfUGluZ01lc3NhZ2U6CiAgICAgICAgcmV0dXJuIGlubmVyLlBpbmcsIG5pbAogICAgY2FzZSAqRWNob01lc3NhZ2VfUG9uZ01lc3NhZ2U6CiAgICAgICAgcmV0dXJuIGlubmVyLlBvbmcsIG5pbAogICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gbmlsLCBmbXQuRXJyb3JmKCZxdW90O3Vua25vd24gbWVzc2FnZSAlVCZxdW90OywgaW5uZXIpCiAgICB9Cn0K"}}),e._v(" "),t("p",[e._v("The reactor itself would be implemented e.g. like this:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gUnVuRWNob1JlYWN0b3Igd2lyZXMgdXAgYW4gZWNobyByZWFjdG9yIHRvIGEgcm91dGVyIGFuZCBydW5zIGl0LgpmdW5jIFJ1bkVjaG9SZWFjdG9yKHJvdXRlciAqcDJwLlJvdXRlcikgZXJyb3IgewogICAgY3R4LCBjYW5jZWwgOj0gY29udGV4dC5XaXRoQ2FuY2VsKGNvbnRleHQuQmFja2dyb3VuZCgpKQogICAgZGVmZXIgY2FuY2VsKCkKCiAgICBjaGFubmVsLCBlcnIgOj0gcm91dGVyLkNoYW5uZWwoMSwgJmFtcDtFY2hvTWVzc2FnZXt9KQogICAgaWYgZXJyICE9IG5pbCB7CiAgICAgICAgcmV0dXJuIGVycgogICAgfQogICAgZGVmZXIgY2hhbm5lbC5DbG9zZSgpCgogICAgcmV0dXJuIEVjaG9SZWFjdG9yKGN0eCwgY2hhbm5lbCwgcm91dGVyLlBlZXJVcGRhdGVzKGN0eCkpCn0KCi8vIEVjaG9SZWFjdG9yIHByb3ZpZGVzIGFuIGVjaG8gc2VydmljZSwgcGluZ2luZyBhbGwga25vd24gcGVlcnMgdW50aWwgY2FuY2VsbGVkLgpmdW5jIEVjaG9SZWFjdG9yKGN0eCBjb250ZXh0LkNvbnRleHQsIGNoYW5uZWwgKnAycC5DaGFubmVsLCBwZWVyVXBkYXRlcyBwMnAuUGVlclVwZGF0ZXMpIGVycm9yIHsKICAgIHRpY2tlciA6PSB0aW1lLk5ld1RpY2tlcig1ICogdGltZS5TZWNvbmQpCiAgICBkZWZlciB0aWNrZXIuU3RvcCgpCgogICAgZm9yIHsKICAgICAgICBzZWxlY3QgewogICAgICAgIC8vIFNlbmQgcGluZyBtZXNzYWdlIHRvIGFsbCBrbm93biBwZWVycyBldmVyeSA1IHNlY29uZHMuCiAgICAgICAgY2FzZSAmbHQ7LXRpY2tlci5DOgogICAgICAgICAgICBjaGFubmVsLk91dCAmbHQ7LSBFbnZlbG9wZXsKICAgICAgICAgICAgICAgIEJyb2FkY2FzdDogdHJ1ZSwKICAgICAgICAgICAgICAgIE1lc3NhZ2U6ICAgJmFtcDtQaW5nTWVzc2FnZXtDb250ZW50OiAmcXVvdDvwn5GLJnF1b3Q7fSwKICAgICAgICAgICAgfQoKICAgICAgICAvLyBXaGVuIHdlIHJlY2VpdmUgYSBtZXNzYWdlIGZyb20gYSBwZWVyLCBlaXRoZXIgcmVzcG9uZCB0byBwaW5nLCBvdXRwdXQKICAgICAgICAvLyBwb25nLCBvciByZXBvcnQgcGVlciBlcnJvciBvbiB1bmtub3duIG1lc3NhZ2UgdHlwZS4KICAgICAgICBjYXNlIGVudmVsb3BlIDo9ICZsdDstY2hhbm5lbC5JbjoKICAgICAgICAgICAgc3dpdGNoIG1zZyA6PSBlbnZlbG9wZS5NZXNzYWdlLih0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgKlBpbmdNZXNzYWdlOgogICAgICAgICAgICAgICAgY2hhbm5lbC5PdXQgJmx0Oy0gRW52ZWxvcGV7CiAgICAgICAgICAgICAgICAgICAgVG86ICAgICAgZW52ZWxvcGUuRnJvbSwKICAgICAgICAgICAgICAgICAgICBNZXNzYWdlOiAmYW1wO1BvbmdNZXNzYWdle0NvbnRlbnQ6IG1zZy5Db250ZW50fSwKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNhc2UgKlBvbmdNZXNzYWdlOgogICAgICAgICAgICAgICAgZm10LlByaW50ZigmcXVvdDslcSByZXBsaWVkIHdpdGggJXFcbiZxdW90OywgZW52ZWxvcGUuRnJvbSwgbXNnLkNvbnRlbnQpCgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgY2hhbm5lbC5FcnJvciAmbHQ7LSBQZWVyRXJyb3J7CiAgICAgICAgICAgICAgICAgICAgUGVlcklEOiAgIGVudmVsb3BlLkZyb20sCiAgICAgICAgICAgICAgICAgICAgRXJyOiAgICAgIGZtdC5FcnJvcmYoJnF1b3Q7dW5leHBlY3RlZCBtZXNzYWdlICVUJnF1b3Q7LCBtc2cpLAogICAgICAgICAgICAgICAgICAgIFNldmVyaXR5OiBQZWVyRXJyb3JTZXZlcml0eUxvdywKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAvLyBPdXRwdXQgaW5mbyBhYm91dCBhbnkgcGVlciBzdGF0dXMgY2hhbmdlcy4KICAgICAgICBjYXNlIHBlZXJVcGRhdGUgOj0gJmx0Oy1wZWVyVXBkYXRlczoKICAgICAgICAgICAgZm10LlByaW50ZigmcXVvdDtQZWVyICVxIGNoYW5nZWQgc3RhdHVzIHRvICVxJnF1b3Q7LCBwZWVyVXBkYXRlLlBlZXJJRCwgcGVlclVwZGF0ZS5TdGF0dXMpCgogICAgICAgIC8vIEV4aXQgd2hlbiBjb250ZXh0IGlzIGNhbmNlbGxlZC4KICAgICAgICBjYXNlICZsdDstY3R4LkRvbmUoKToKICAgICAgICAgICAgcmV0dXJuIG5pbAogICAgICAgIH0KICAgIH0KfQo="}}),e._v(" "),t("h3",{attrs:{id:"implementation-plan"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#implementation-plan"}},[e._v("#")]),e._v(" Implementation Plan")]),e._v(" "),t("p",[e._v("The existing P2P stack should be gradually migrated towards this design. The easiest path would likely be:")]),e._v(" "),t("ol",[t("li",[t("p",[e._v("Implement the "),t("code",[e._v("Channel")]),e._v(" and "),t("code",[e._v("PeerUpdates")]),e._v(" APIs as shims on top of the current "),t("code",[e._v("Switch")]),e._v(" and "),t("code",[e._v("Peer")]),e._v(" APIs, and rewrite all reactors to use them instead.")])]),e._v(" "),t("li",[t("p",[e._v("Port the "),t("code",[e._v("privval")]),e._v(" package to no longer use "),t("code",[e._v("SecretConnection")]),e._v(" (e.g. by using gRPC instead), or temporarily duplicate its functionality.")])]),e._v(" "),t("li",[t("p",[e._v("Rewrite the current MConn connection and transport code to use the new "),t("code",[e._v("Transport")]),e._v(" API, and migrate existing code to use it instead.")])]),e._v(" "),t("li",[t("p",[e._v("Implement the new "),t("code",[e._v("peer")]),e._v(" and "),t("code",[e._v("peerStore")]),e._v(" APIs, and either make the current address book a shim on top of these or replace it.")])]),e._v(" "),t("li",[t("p",[e._v("Replace the existing "),t("code",[e._v("Switch")]),e._v(" abstraction with the new "),t("code",[e._v("Router")]),e._v(".")])]),e._v(" "),t("li",[t("p",[e._v("Move the PEX reactor and other address advertisement/exchange into the P2P core, possibly the "),t("code",[e._v("Router")]),e._v(".")])]),e._v(" "),t("li",[t("p",[e._v("Consider rewriting and/or cleaning up reactors and other P2P-related code to make better use of the new abstractions.")])])]),e._v(" "),t("p",[e._v("A note on backwards-compatibility: the current MConn protocol takes whole messages expressed as byte slices and splits them up into "),t("code",[e._v("PacketMsg")]),e._v(" messages, where the final packet of a message has "),t("code",[e._v("PacketMsg.EOF")]),e._v(" set. In order to maintain wire-compatibility with this protocol, the MConn transport needs to be aware of message boundaries, even though it does not care what the messages actually are. One way to handle this is to break abstraction boundaries and have the transport decode the input's length-prefixed message framing and use this to determine message boundaries, unless we accept breaking the protocol here.")]),e._v(" "),t("p",[e._v('Similarly, implementing channel handshakes with the current MConn protocol would require doing an initial connection handshake as today and use that information to "fake" the local channel handshake without it hitting the wire.')]),e._v(" "),t("h2",{attrs:{id:"status"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#status"}},[e._v("#")]),e._v(" Status")]),e._v(" "),t("p",[e._v("Accepted")]),e._v(" "),t("h2",{attrs:{id:"consequences"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#consequences"}},[e._v("#")]),e._v(" Consequences")]),e._v(" "),t("h3",{attrs:{id:"positive"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#positive"}},[e._v("#")]),e._v(" Positive")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("Reduced coupling and simplified interfaces should lead to better understandability, increased reliability, and more testing.")])]),e._v(" "),t("li",[t("p",[e._v("Using message passing via Go channels gives better control of backpressure and quality-of-service scheduling.")])]),e._v(" "),t("li",[t("p",[e._v("Peer lifecycle and connection management is centralized in a single entity, making it easier to reason about.")])]),e._v(" "),t("li",[t("p",[e._v("Detection, advertisement, and exchange of node addresses will be improved.")])]),e._v(" "),t("li",[t("p",[e._v("Additional transports (e.g. QUIC) can be implemented and used in parallel with the existing MConn protocol.")])]),e._v(" "),t("li",[t("p",[e._v("The P2P protocol will not be broken in the initial version, if possible.")])])]),e._v(" "),t("h3",{attrs:{id:"negative"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#negative"}},[e._v("#")]),e._v(" Negative")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("Fully implementing the new design as indended is likely to require breaking changes to the P2P protocol at some point, although the initial implementation shouldn't.")])]),e._v(" "),t("li",[t("p",[e._v("Gradually migrating the existing stack and maintaining backwards-compatibility will be more labor-intensive than simply replacing the entire stack.")])]),e._v(" "),t("li",[t("p",[e._v("A complete overhaul of P2P internals is likely to cause temporary performance regressions and bugs as the implementation matures.")])]),e._v(" "),t("li",[t("p",[e._v("Hiding peer management information inside the "),t("code",[e._v("p2p")]),e._v(" package may prevent certain functionality or require additional deliberate interfaces for information exchange, as a tradeoff to simplify the design, reduce coupling, and avoid race conditions and lock contention.")])])]),e._v(" "),t("h3",{attrs:{id:"neutral"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#neutral"}},[e._v("#")]),e._v(" Neutral")]),e._v(" "),t("ul",[t("li",[e._v("Implementation details around e.g. peer management, message scheduling, and peer and endpoint advertisement are not yet determined.")])]),e._v(" "),t("h2",{attrs:{id:"references"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[e._v("#")]),e._v(" References")]),e._v(" "),t("ul",[t("li",[t("RouterLink",{attrs:{to:"/architecture/adr-061-p2p-refactor-scope.html"}},[e._v("ADR 061: P2P Refactor Scope")])],1),e._v(" "),t("li",[t("a",{attrs:{href:"https://github.com/tendermint/tendermint/issues/5670",target:"_blank",rel:"noopener noreferrer"}},[e._v("#5670 p2p: internal refactor and architecture redesign"),t("OutboundLink")],1)])])],1)}),[],!1,null,null,null);a.default=o.exports}}]);