(window.webpackJsonp=window.webpackJsonp||[]).push([[125],{672:function(e,a,t){"use strict";t.r(a);var n=t(1),o=Object(n.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"adr-062-p2p-architecture-and-abstractions"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#adr-062-p2p-architecture-and-abstractions"}},[e._v("#")]),e._v(" ADR 062: P2P Architecture and Abstractions")]),e._v(" "),t("h2",{attrs:{id:"changelog"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#changelog"}},[e._v("#")]),e._v(" Changelog")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("2020-11-09: Initial version (@erikgrinaker)")])]),e._v(" "),t("li",[t("p",[e._v("2020-11-13: Remove stream IDs, move peer errors onto channel, note on moving PEX into core (@erikgrinaker)")])]),e._v(" "),t("li",[t("p",[e._v("2020-11-16: Notes on recommended reactor implementation patterns, approve ADR (@erikgrinaker)")])]),e._v(" "),t("li",[t("p",[e._v("2021-02-04: Update with new P2P core and Transport API changes (@erikgrinaker).")])])]),e._v(" "),t("h2",{attrs:{id:"context"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#context"}},[e._v("#")]),e._v(" Context")]),e._v(" "),t("p",[e._v("In "),t("RouterLink",{attrs:{to:"/architecture/adr-061-p2p-refactor-scope.html"}},[e._v("ADR 061")]),e._v(" we decided to refactor the peer-to-peer (P2P) networking stack. The first phase is to redesign and refactor the internal P2P architecture, while retaining protocol compatibility as far as possible.")],1),e._v(" "),t("h2",{attrs:{id:"alternative-approaches"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#alternative-approaches"}},[e._v("#")]),e._v(" Alternative Approaches")]),e._v(" "),t("p",[e._v("Several variations of the proposed design were considered, including e.g. calling interface methods instead of passing messages (like the current architecture), merging channels with streams, exposing the internal peer data structure to reactors, being message format-agnostic via arbitrary codecs, and so on. This design was chosen because it has very loose coupling, is simpler to reason about and more convenient to use, avoids race conditions and lock contention for internal data structures, gives reactors better control of message ordering and processing semantics, and allows for QoS scheduling and backpressure in a very natural way.")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://github.com/multiformats/multiaddr",target:"_blank",rel:"noopener noreferrer"}},[e._v("multiaddr"),t("OutboundLink")],1),e._v(" was considered as a transport-agnostic peer address format over regular URLs, but it does not appear to have very widespread adoption, and advanced features like protocol encapsulation and tunneling do not appear to be immediately useful to us.")]),e._v(" "),t("p",[e._v("There were also proposals to use LibP2P instead of maintaining our own P2P stack, which were rejected (for now) in "),t("RouterLink",{attrs:{to:"/architecture/adr-061-p2p-refactor-scope.html"}},[e._v("ADR 061")]),e._v(".")],1),e._v(" "),t("p",[e._v("The initial version of this ADR had a byte-oriented multi-stream transport API, but this had to be abandoned/postponed to maintain backwards-compatibility with the existing MConnection protocol which is message-oriented. See the rejected RFC in "),t("a",{attrs:{href:"https://github.com/tendermint/spec/pull/227",target:"_blank",rel:"noopener noreferrer"}},[e._v("tendermint/spec#227"),t("OutboundLink")],1),e._v(" for details.")]),e._v(" "),t("h2",{attrs:{id:"decision"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#decision"}},[e._v("#")]),e._v(" Decision")]),e._v(" "),t("p",[e._v("The P2P stack will be redesigned as a message-oriented architecture, primarily relying on Go channels for communication and scheduling. It will use a message-oriented transport to binary messages with individual peers, bidirectional peer-addressable channels to send and receive Protobuf messages, a router to route messages between reactors and peers, and a peer manager to manage peer lifecycle information. Message passing is asynchronous with at-most-once delivery.")]),e._v(" "),t("h2",{attrs:{id:"detailed-design"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#detailed-design"}},[e._v("#")]),e._v(" Detailed Design")]),e._v(" "),t("p",[e._v("This ADR is primarily concerned with the architecture and interfaces of the P2P stack, not implementation details. The interfaces described here should therefore be considered a rough architecture outline, not a complete and final design.")]),e._v(" "),t("p",[e._v("Primary design objectives have been:")]),e._v(" "),t("ul",[t("li",[e._v("Loose coupling between components, for a simpler, more robust, and test-friendly architecture.")]),e._v(" "),t("li",[e._v("Pluggable transports (not necessarily networked).")]),e._v(" "),t("li",[e._v("Better scheduling of messages, with improved prioritization, backpressure, and performance.")]),e._v(" "),t("li",[e._v("Centralized peer lifecycle and connection management.")]),e._v(" "),t("li",[e._v("Better peer address detection, advertisement, and exchange.")]),e._v(" "),t("li",[e._v("Wire-level backwards compatibility with current P2P network protocols, except where it proves too obstructive.")])]),e._v(" "),t("p",[e._v("The main abstractions in the new stack are:")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("Transport")]),e._v(": An arbitrary mechanism to exchange binary messages with a peer across a "),t("code",[e._v("Connection")]),e._v(".")]),e._v(" "),t("li",[t("code",[e._v("Channel")]),e._v(": A bidirectional channel to asynchronously exchange Protobuf messages with peers using node ID addressing.")]),e._v(" "),t("li",[t("code",[e._v("Router")]),e._v(": Maintains transport connections to relevant peers and routes channel messages.")]),e._v(" "),t("li",[t("code",[e._v("PeerManager")]),e._v(": Manages peer lifecycle information, e.g. deciding which peers to dial and when, using a "),t("code",[e._v("peerStore")]),e._v(" for storage.")]),e._v(" "),t("li",[e._v('Reactor: A design pattern loosely defined as "something which listens on a channel and reacts to messages".')])]),e._v(" "),t("p",[e._v("These abstractions are illustrated in the following diagram (representing the internals of node A) and described in detail below.")]),e._v(" "),t("p",[t("img",{attrs:{src:"img/adr-062-architecture.svg",alt:"P2P Architecture Diagram"}})]),e._v(" "),t("h3",{attrs:{id:"transports"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#transports"}},[e._v("#")]),e._v(" Transports")]),e._v(" "),t("p",[e._v('Transports are arbitrary mechanisms for exchanging binary messages with a peer. For example, a gRPC transport would connect to a peer over TCP/IP and send data using the gRPC protocol, while an in-memory transport might communicate with a peer running in another goroutine using internal Go channels. Note that transports don\'t have a notion of a "peer" or "node" as such - instead, they establish connections between arbitrary endpoint addresses (e.g. IP address and port number), to decouple them from the rest of the P2P stack.')]),e._v(" "),t("p",[e._v("Transports must satisfy the following requirements:")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("Be connection-oriented, and support both listening for inbound connections and making outbound connections using endpoint addresses.")])]),e._v(" "),t("li",[t("p",[e._v("Support sending binary messages with distinct channel IDs (although channels and channel IDs are a higher-level application protocol concept explained in the Router section, they are threaded through the transport layer as well for backwards compatibilty with the existing MConnection protocol).")])]),e._v(" "),t("li",[t("p",[e._v("Exchange the MConnection "),t("code",[e._v("NodeInfo")]),e._v(" and public key via a node handshake, and possibly encrypt or sign the traffic as appropriate.")])])]),e._v(" "),t("p",[e._v("The initial transport is a port of the current MConnection protocol currently used by Tendermint, and should be backwards-compatible at the wire level. An in-memory transport for testing has also been implemented. There are plans to explore a QUIC transport that may replace the MConnection protocol.")]),e._v(" "),t("p",[e._v("The "),t("code",[e._v("Transport")]),e._v(" interface is as follows:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gVHJhbnNwb3J0IGlzIGEgY29ubmVjdGlvbi1vcmllbnRlZCBtZWNoYW5pc20gZm9yIGV4Y2hhbmdpbmcgZGF0YSB3aXRoIGEgcGVlci4KdHlwZSBUcmFuc3BvcnQgaW50ZXJmYWNlIHsKICAgIC8vIFByb3RvY29scyByZXR1cm5zIHRoZSBwcm90b2NvbHMgc3VwcG9ydGVkIGJ5IHRoZSB0cmFuc3BvcnQuIFRoZSBSb3V0ZXIKICAgIC8vIHVzZXMgdGhpcyB0byBwaWNrIGEgdHJhbnNwb3J0IGZvciBhbiBFbmRwb2ludC4KICAgIFByb3RvY29scygpIFtdUHJvdG9jb2wKCiAgICAvLyBFbmRwb2ludHMgcmV0dXJucyB0aGUgbG9jYWwgZW5kcG9pbnRzIHRoZSB0cmFuc3BvcnQgaXMgbGlzdGVuaW5nIG9uLCBpZiBhbnkuCiAgICAvLyBIb3cgdG8gbGlzdGVuIGlzIHRyYW5zcG9ydC1kZXBlbmRlbnQsIGUuZy4gTUNvbm5UcmFuc3BvcnQgdXNlcyBMaXN0ZW4oKSB3aGlsZQogICAgLy8gTWVtb3J5VHJhbnNwb3J0IHN0YXJ0cyBsaXN0ZW5pbmcgdmlhIE1lbW9yeU5ldHdvcmsuQ3JlYXRlVHJhbnNwb3J0KCkuCiAgICBFbmRwb2ludHMoKSBbXUVuZHBvaW50CgogICAgLy8gQWNjZXB0IHdhaXRzIGZvciB0aGUgbmV4dCBpbmJvdW5kIGNvbm5lY3Rpb24gb24gYSBsaXN0ZW5pbmcgZW5kcG9pbnQsIGJsb2NraW5nCiAgICAvLyB1bnRpbCBlaXRoZXIgYSBjb25uZWN0aW9uIGlzIGF2YWlsYWJsZSBvciB0aGUgdHJhbnNwb3J0IGlzIGNsb3NlZC4gT24gY2xvc3VyZSwKICAgIC8vIGlvLkVPRiBpcyByZXR1cm5lZCBhbmQgZnVydGhlciBBY2NlcHQgY2FsbHMgYXJlIGZ1dGlsZS4KICAgIEFjY2VwdCgpIChDb25uZWN0aW9uLCBlcnJvcikKCiAgICAvLyBEaWFsIGNyZWF0ZXMgYW4gb3V0Ym91bmQgY29ubmVjdGlvbiB0byBhbiBlbmRwb2ludC4KICAgIERpYWwoY29udGV4dC5Db250ZXh0LCBFbmRwb2ludCkgKENvbm5lY3Rpb24sIGVycm9yKQoKICAgIC8vIENsb3NlIHN0b3BzIGFjY2VwdGluZyBuZXcgY29ubmVjdGlvbnMsIGJ1dCBkb2VzIG5vdCBjbG9zZSBhY3RpdmUgY29ubmVjdGlvbnMuCiAgICBDbG9zZSgpIGVycm9yCn0K"}}),e._v(" "),t("p",[e._v("How the transport configures listening is transport-dependent, and not covered by the interface. This typically happens during transport construction, where a single instance of the transport is created and set to listen on an appropriate network interface before being passed to the router.")]),e._v(" "),t("h4",{attrs:{id:"endpoints"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#endpoints"}},[e._v("#")]),e._v(" Endpoints")]),e._v(" "),t("p",[t("code",[e._v("Endpoint")]),e._v(" represents a transport endpoint (e.g. an IP address and port). A connection always has two endpoints: one at the local node and one at the remote peer. Outbound connections to remote endpoints are made via "),t("code",[e._v("Dial()")]),e._v(", and inbound connections to listening endpoints are returned via "),t("code",[e._v("Accept()")]),e._v(".")]),e._v(" "),t("p",[e._v("The "),t("code",[e._v("Endpoint")]),e._v(" struct is:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gRW5kcG9pbnQgcmVwcmVzZW50cyBhIHRyYW5zcG9ydCBjb25uZWN0aW9uIGVuZHBvaW50LCBlaXRoZXIgbG9jYWwgb3IgcmVtb3RlLgovLwovLyBFbmRwb2ludHMgYXJlIG5vdCBuZWNlc3NhcmlseSBuZXR3b3JrZWQgKHNlZSBlLmcuIE1lbW9yeVRyYW5zcG9ydCkgYnV0IGFsbAovLyBuZXR3b3JrZWQgZW5kcG9pbnRzIG11c3QgdXNlIElQIGFzIHRoZSB1bmRlcmx5aW5nIHRyYW5zcG9ydCBwcm90b2NvbCB0byBhbGxvdwovLyBlLmcuIElQIGFkZHJlc3MgZmlsdGVyaW5nLiBFaXRoZXIgSVAgb3IgUGF0aCAob3IgYm90aCkgbXVzdCBiZSBzZXQuCnR5cGUgRW5kcG9pbnQgc3RydWN0IHsKICAgIC8vIFByb3RvY29sIHNwZWNpZmllcyB0aGUgdHJhbnNwb3J0IHByb3RvY29sLgogICAgUHJvdG9jb2wgUHJvdG9jb2wKCiAgICAvLyBJUCBpcyBhbiBJUCBhZGRyZXNzICh2NCBvciB2NikgdG8gY29ubmVjdCB0by4gSWYgc2V0LCB0aGlzIGRlZmluZXMgdGhlCiAgICAvLyBlbmRwb2ludCBhcyBhIG5ldHdvcmtlZCBlbmRwb2ludC4KICAgIElQIG5ldC5JUAoKICAgIC8vIFBvcnQgaXMgYSBuZXR3b3JrIHBvcnQgKGVpdGhlciBUQ1Agb3IgVURQKS4gSWYgMCwgYSBkZWZhdWx0IHBvcnQgbWF5IGJlCiAgICAvLyB1c2VkIGRlcGVuZGluZyBvbiB0aGUgcHJvdG9jb2wuCiAgICBQb3J0IHVpbnQxNgoKICAgIC8vIFBhdGggaXMgYW4gb3B0aW9uYWwgdHJhbnNwb3J0LXNwZWNpZmljIHBhdGggb3IgaWRlbnRpZmllci4KICAgIFBhdGggc3RyaW5nCn0KCi8vIFByb3RvY29sIGlkZW50aWZpZXMgYSB0cmFuc3BvcnQgcHJvdG9jb2wuCnR5cGUgUHJvdG9jb2wgc3RyaW5nCg=="}}),e._v(" "),t("p",[e._v("Endpoints are arbitrary transport-specific addresses, but if they are networked they must use IP addresses and thus rely on IP as a fundamental packet routing protocol. This enables policies for address discovery, advertisement, and exchange - for example, a private "),t("code",[e._v("192.168.0.0/24")]),e._v(" IP address should only be advertised to peers on that IP network, while the public address "),t("code",[e._v("8.8.8.8")]),e._v(" may be advertised to all peers. Similarly, any port numbers if given must represent TCP and/or UDP port numbers, in order to use "),t("a",{attrs:{href:"https://en.wikipedia.org/wiki/Universal_Plug_and_Play",target:"_blank",rel:"noopener noreferrer"}},[e._v("UPnP"),t("OutboundLink")],1),e._v(" to autoconfigure e.g. NAT gateways.")]),e._v(" "),t("p",[e._v("Non-networked endpoints (without an IP address) are considered local, and will only be advertised to other peers connecting via the same protocol. For example, the in-memory transport used for testing uses "),t("code",[e._v('Endpoint{Protocol: "memory", Path: "foo"}')]),e._v(' as an address for the node "foo", and this should only be advertised to other nodes using '),t("code",[e._v('Protocol: "memory"')]),e._v(".")]),e._v(" "),t("h4",{attrs:{id:"connections"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#connections"}},[e._v("#")]),e._v(" Connections")]),e._v(" "),t("p",[e._v("A connection represents an established transport connection between two endpoints (i.e. two nodes), which can be used to exchange binary messages with logical channel IDs (corresponding to the higher-level channel IDs used in the router). Connections are set up either via "),t("code",[e._v("Transport.Dial()")]),e._v(" (outbound) or "),t("code",[e._v("Transport.Accept()")]),e._v(" (inbound).")]),e._v(" "),t("p",[e._v("Once a connection is esablished, "),t("code",[e._v("Transport.Handshake()")]),e._v(" must be called to perform a node handshake, exchanging node info and public keys to verify node identities. Node handshakes should not really be part of the transport layer (it's an application protocol concern), this exists for backwards-compatibility with the existing MConnection protocol which conflates the two. "),t("code",[e._v("NodeInfo")]),e._v(" is part of the existing MConnection protocol, but does not appear to be documented in the specification -- refer to the Go codebase for details.")]),e._v(" "),t("p",[e._v("The "),t("code",[e._v("Connection")]),e._v(" interface is shown below. It omits certain additions that are currently implemented for backwards compatibility with the legacy P2P stack and are planned to be removed before the final release.")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gQ29ubmVjdGlvbiByZXByZXNlbnRzIGFuIGVzdGFibGlzaGVkIGNvbm5lY3Rpb24gYmV0d2VlbiB0d28gZW5kcG9pbnRzLgp0eXBlIENvbm5lY3Rpb24gaW50ZXJmYWNlIHsKICAgIC8vIEhhbmRzaGFrZSBleGVjdXRlcyBhIG5vZGUgaGFuZHNoYWtlIHdpdGggdGhlIHJlbW90ZSBwZWVyLiBJdCBtdXN0IGJlCiAgICAvLyBjYWxsZWQgb25jZSB0aGUgY29ubmVjdGlvbiBpcyBlc3RhYmxpc2hlZCwgYW5kIHJldHVybnMgdGhlIHJlbW90ZSBwZWVyJ3MKICAgIC8vIG5vZGUgaW5mbyBhbmQgcHVibGljIGtleS4gVGhlIGNhbGxlciBpcyByZXNwb25zaWJsZSBmb3IgdmFsaWRhdGlvbi4KICAgIEhhbmRzaGFrZShjb250ZXh0LkNvbnRleHQsIE5vZGVJbmZvLCBjcnlwdG8uUHJpdktleSkgKE5vZGVJbmZvLCBjcnlwdG8uUHViS2V5LCBlcnJvcikKCiAgICAvLyBSZWNlaXZlTWVzc2FnZSByZXR1cm5zIHRoZSBuZXh0IG1lc3NhZ2UgcmVjZWl2ZWQgb24gdGhlIGNvbm5lY3Rpb24sCiAgICAvLyBibG9ja2luZyB1bnRpbCBvbmUgaXMgYXZhaWxhYmxlLiBSZXR1cm5zIGlvLkVPRiBpZiBjbG9zZWQuCiAgICBSZWNlaXZlTWVzc2FnZSgpIChDaGFubmVsSUQsIFtdYnl0ZSwgZXJyb3IpCgogICAgLy8gU2VuZE1lc3NhZ2Ugc2VuZHMgYSBtZXNzYWdlIG9uIHRoZSBjb25uZWN0aW9uLiBSZXR1cm5zIGlvLkVPRiBpZiBjbG9zZWQuCiAgICBTZW5kTWVzc2FnZShDaGFubmVsSUQsIFtdYnl0ZSkgZXJyb3IKCiAgICAvLyBMb2NhbEVuZHBvaW50IHJldHVybnMgdGhlIGxvY2FsIGVuZHBvaW50IGZvciB0aGUgY29ubmVjdGlvbi4KICAgIExvY2FsRW5kcG9pbnQoKSBFbmRwb2ludAoKICAgIC8vIFJlbW90ZUVuZHBvaW50IHJldHVybnMgdGhlIHJlbW90ZSBlbmRwb2ludCBmb3IgdGhlIGNvbm5lY3Rpb24uCiAgICBSZW1vdGVFbmRwb2ludCgpIEVuZHBvaW50CgogICAgLy8gQ2xvc2UgY2xvc2VzIHRoZSBjb25uZWN0aW9uLgogICAgQ2xvc2UoKSBlcnJvcgp9Cg=="}}),e._v(" "),t("p",[e._v("This ADR initially proposed a byte-oriented multi-stream connection API that follows more typical networking API conventions (using e.g. "),t("code",[e._v("io.Reader")]),e._v(" and "),t("code",[e._v("io.Writer")]),e._v(" interfaces which easily compose with other libraries). This would also allow moving the responsibility for message framing, node handshakes, and traffic scheduling to the common router instead of reimplementing this across transports, and would allow making better use of multi-stream protocols such as QUIC. However, this would require minor breaking changes to the MConnection protocol which were rejected, see "),t("a",{attrs:{href:"https://github.com/tendermint/spec/pull/227",target:"_blank",rel:"noopener noreferrer"}},[e._v("tendermint/spec#227"),t("OutboundLink")],1),e._v(" for details. This should be revisited when starting work on a QUIC transport.")]),e._v(" "),t("h3",{attrs:{id:"peer-management"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#peer-management"}},[e._v("#")]),e._v(" Peer Management")]),e._v(" "),t("p",[e._v("Peers are other Tendermint nodes. Each peer is identified by a unique "),t("code",[e._v("NodeID")]),e._v(" (tied to the node's private key).")]),e._v(" "),t("h4",{attrs:{id:"peer-addresses"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#peer-addresses"}},[e._v("#")]),e._v(" Peer Addresses")]),e._v(" "),t("p",[e._v("Nodes have one or more "),t("code",[e._v("NodeAddress")]),e._v(" addresses expressed as URLs that they can be reached at. Examples of node addresses might be e.g.:")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("mconn://nodeid@host.domain.com:25567/path")])]),e._v(" "),t("li",[t("code",[e._v("memory:nodeid")])])]),e._v(" "),t("p",[e._v("Addresses are resolved into one or more transport endpoints, e.g. by resolving DNS hostnames into IP addresses. Peers should always be expressed as address URLs rather than endpoints (which are a lower-level transport construct).")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gTm9kZUlEIGlzIGEgaGV4LWVuY29kZWQgY3J5cHRvLkFkZHJlc3MuIEl0IG11c3QgYmUgbG93ZXJjYXNlZAovLyAoZm9yIHVuaXF1ZW5lc3MpIGFuZCBvZiBsZW5ndGggNDAuCnR5cGUgTm9kZUlEIHN0cmluZwoKLy8gTm9kZUFkZHJlc3MgaXMgYSBub2RlIGFkZHJlc3MgVVJMLiBJdCBkaWZmZXJzIGZyb20gYSB0cmFuc3BvcnQgRW5kcG9pbnQgaW4KLy8gdGhhdCBpdCBjb250YWlucyB0aGUgbm9kZSdzIElELCBhbmQgdGhhdCB0aGUgYWRkcmVzcyBob3N0bmFtZSBtYXkgYmUgcmVzb2x2ZWQKLy8gaW50byBtdWx0aXBsZSBJUCBhZGRyZXNzZXMgKGFuZCB0aHVzIG11bHRpcGxlIGVuZHBvaW50cykuCi8vCi8vIElmIHRoZSBVUkwgaXMgb3BhcXVlLCBpLmUuIG9mIHRoZSBmb3JtICZxdW90O3NjaGVtZTpvcGFxdWUmcXVvdDssIHRoZW4gdGhlIG9wYXF1ZSBwYXJ0Ci8vIGlzIGV4cGVjdGVkIHRvIGNvbnRhaW4gYSBub2RlIElELgp0eXBlIE5vZGVBZGRyZXNzIHN0cnVjdCB7CiAgICBOb2RlSUQgICBOb2RlSUQKICAgIFByb3RvY29sIFByb3RvY29sCiAgICBIb3N0bmFtZSBzdHJpbmcKICAgIFBvcnQgICAgIHVpbnQxNgogICAgUGF0aCAgICAgc3RyaW5nCn0KCi8vIFBhcnNlTm9kZUFkZHJlc3MgcGFyc2VzIGEgbm9kZSBhZGRyZXNzIFVSTCBpbnRvIGEgTm9kZUFkZHJlc3MsIG5vcm1hbGl6aW5nCi8vIGFuZCB2YWxpZGF0aW5nIGl0LgpmdW5jIFBhcnNlTm9kZUFkZHJlc3ModXJsU3RyaW5nIHN0cmluZykgKE5vZGVBZGRyZXNzLCBlcnJvcikKCi8vIFJlc29sdmUgcmVzb2x2ZXMgYSBOb2RlQWRkcmVzcyBpbnRvIGEgc2V0IG9mIEVuZHBvaW50cywgZS5nLiBieSBleHBhbmRpbmcKLy8gb3V0IGEgRE5TIGhvc3RuYW1lIHRvIElQIGFkZHJlc3Nlcy4KZnVuYyAoYSBOb2RlQWRkcmVzcykgUmVzb2x2ZShjdHggY29udGV4dC5Db250ZXh0KSAoW11FbmRwb2ludCwgZXJyb3IpCg=="}}),e._v(" "),t("h4",{attrs:{id:"peer-manager"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#peer-manager"}},[e._v("#")]),e._v(" Peer Manager")]),e._v(" "),t("p",[e._v("The P2P stack needs to track a lot of internal state about peers, such as their addresses, connection state, priorities, availability, failures, retries, and so on. This responsibility has been separated out to a "),t("code",[e._v("PeerManager")]),e._v(", which track this state for the "),t("code",[e._v("Router")]),e._v(" (but does not maintain the actual transport connections themselves, which is the router's responsibility).")]),e._v(" "),t("p",[e._v("The "),t("code",[e._v("PeerManager")]),e._v(" is a synchronous state machine, where all state transitions are serialized (implemented as synchronous method calls holding an exclusive mutex lock). Most peer state is intentionally kept internal, stored in a "),t("code",[e._v("peerStore")]),e._v(" database that persists it as appropriate, and the external interfaces pass the minimum amount of information necessary in order to avoid shared state between router goroutines. This design significantly simplifies the model, making it much easier to reason about and test than if it was baked into the asynchronous ball of concurrency that the P2P networking core must necessarily be. As peer lifecycle events are expected to be relatively infrequent, this should not significantly impact performance either.")]),e._v(" "),t("p",[e._v("The "),t("code",[e._v("Router")]),e._v(" uses the "),t("code",[e._v("PeerManager")]),e._v(" to request which peers to dial and evict, and reports in with peer lifecycle events such as connections, disconnections, and failures as they occur. The manager can reject these events (e.g. reject an inbound connection) by returning errors. This happens as follows:")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("Outbound connections, via "),t("code",[e._v("Transport.Dial")]),e._v(":")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("DialNext()")]),e._v(": returns a peer address to dial, or blocks until one is available.")]),e._v(" "),t("li",[t("code",[e._v("DialFailed()")]),e._v(": reports a peer dial failure.")]),e._v(" "),t("li",[t("code",[e._v("Dialed()")]),e._v(": reports a peer dial success.")]),e._v(" "),t("li",[t("code",[e._v("Ready()")]),e._v(": reports the peer as routed and ready.")]),e._v(" "),t("li",[t("code",[e._v("Disconnected()")]),e._v(": reports a peer disconnection.")])])]),e._v(" "),t("li",[t("p",[e._v("Inbound connections, via "),t("code",[e._v("Transport.Accept")]),e._v(":")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("Accepted()")]),e._v(": reports an inbound peer connection.")]),e._v(" "),t("li",[t("code",[e._v("Ready()")]),e._v(": reports the peer as routed and ready.")]),e._v(" "),t("li",[t("code",[e._v("Disconnected()")]),e._v(": reports a peer disconnection.")])])]),e._v(" "),t("li",[t("p",[e._v("Evictions, via "),t("code",[e._v("Connection.Close")]),e._v(":")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("EvictNext()")]),e._v(": returns a peer to disconnect, or blocks until one is available.")]),e._v(" "),t("li",[t("code",[e._v("Disconnected()")]),e._v(": reports a peer disconnection.")])])])]),e._v(" "),t("p",[e._v("These calls have the following interface:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gRGlhbE5leHQgcmV0dXJucyBhIHBlZXIgYWRkcmVzcyB0byBkaWFsLCBibG9ja2luZyB1bnRpbCBvbmUgaXMgYXZhaWxhYmxlLgpmdW5jIChtICpQZWVyTWFuYWdlcikgRGlhbE5leHQoY3R4IGNvbnRleHQuQ29udGV4dCkgKE5vZGVBZGRyZXNzLCBlcnJvcikKCi8vIERpYWxGYWlsZWQgcmVwb3J0cyBhIGRpYWwgZmFpbHVyZSBmb3IgdGhlIGdpdmVuIGFkZHJlc3MuCmZ1bmMgKG0gKlBlZXJNYW5hZ2VyKSBEaWFsRmFpbGVkKGFkZHJlc3MgTm9kZUFkZHJlc3MpIGVycm9yCgovLyBEaWFsZWQgcmVwb3J0cyBhIHN1Y2Nlc3NmdWwgb3V0Ym91bmQgY29ubmVjdGlvbiB0byB0aGUgZ2l2ZW4gYWRkcmVzcy4KZnVuYyAobSAqUGVlck1hbmFnZXIpIERpYWxlZChhZGRyZXNzIE5vZGVBZGRyZXNzKSBlcnJvcgoKLy8gQWNjZXB0ZWQgcmVwb3J0cyBhIHN1Y2Nlc3NmdWwgaW5ib3VuZCBjb25uZWN0aW9uIGZyb20gdGhlIGdpdmVuIG5vZGUuCmZ1bmMgKG0gKlBlZXJNYW5hZ2VyKSBBY2NlcHRlZChwZWVySUQgTm9kZUlEKSBlcnJvcgoKLy8gUmVhZHkgcmVwb3J0cyB0aGUgcGVlciBhcyBmdWxseSByb3V0ZWQgYW5kIHJlYWR5IGZvciB1c2UuCmZ1bmMgKG0gKlBlZXJNYW5hZ2VyKSBSZWFkeShwZWVySUQgTm9kZUlEKSBlcnJvcgoKLy8gRXZpY3ROZXh0IHJldHVybnMgYSBwZWVyIElEIHRvIGRpc2Nvbm5lY3QsIGJsb2NraW5nIHVudGlsIG9uZSBpcyBhdmFpbGFibGUuCmZ1bmMgKG0gKlBlZXJNYW5hZ2VyKSBFdmljdE5leHQoY3R4IGNvbnRleHQuQ29udGV4dCkgKE5vZGVJRCwgZXJyb3IpCgovLyBEaXNjb25uZWN0ZWQgcmVwb3J0cyBhIHBlZXIgZGlzY29ubmVjdGlvbi4KZnVuYyAobSAqUGVlck1hbmFnZXIpIERpc2Nvbm5lY3RlZChwZWVySUQgTm9kZUlEKSBlcnJvcgo="}}),e._v(" "),t("p",[e._v("Internally, the "),t("code",[e._v("PeerManager")]),e._v(" uses a numeric peer score to prioritize peers, e.g. when deciding which peers to dial next. The scoring policy has not yet been implemented, but should take into account e.g. node configuration such a "),t("code",[e._v("persistent_peers")]),e._v(", uptime and connection failures, performance, and so on. The manager will also attempt to automatically upgrade to better-scored peers by evicting lower-scored peers when a better one becomes available (e.g. when a persistent peer comes back online after an outage).")]),e._v(" "),t("p",[e._v("The "),t("code",[e._v("PeerManager")]),e._v(" should also have an API for reporting peer behavior from reactors that affects its score (e.g. signing a block increases the score, double-voting decreases it or even bans the peer), but this has not yet been designed and implemented.")]),e._v(" "),t("p",[e._v("Additionally, the "),t("code",[e._v("PeerManager")]),e._v(" provides "),t("code",[e._v("PeerUpdates")]),e._v(" subscriptions that will receive "),t("code",[e._v("PeerUpdate")]),e._v(" events whenever significant peer state changes happen. Reactors can use these e.g. to know when peers are connected or disconnected, and take appropriate action. This is currently fairly minimal:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gU3Vic2NyaWJlIHN1YnNjcmliZXMgdG8gcGVlciB1cGRhdGVzLiBUaGUgY2FsbGVyIG11c3QgY29uc3VtZSB0aGUgcGVlciB1cGRhdGVzCi8vIGluIGEgdGltZWx5IGZhc2hpb24gYW5kIGNsb3NlIHRoZSBzdWJzY3JpcHRpb24gd2hlbiBkb25lLCB0byBhdm9pZCBzdGFsbGluZyB0aGUKLy8gUGVlck1hbmFnZXIgYXMgZGVsaXZlcnkgaXMgc2VtaS1zeW5jaHJvbm91cywgZ3VhcmFudGVlZCwgYW5kIG9yZGVyZWQuCmZ1bmMgKG0gKlBlZXJNYW5hZ2VyKSBTdWJzY3JpYmUoKSAqUGVlclVwZGF0ZXMKCi8vIFBlZXJVcGRhdGUgaXMgYSBwZWVyIHVwZGF0ZSBldmVudCBzZW50IHZpYSBQZWVyVXBkYXRlcy4KdHlwZSBQZWVyVXBkYXRlIHN0cnVjdCB7CiAgICBOb2RlSUQgTm9kZUlECiAgICBTdGF0dXMgUGVlclN0YXR1cwp9CgovLyBQZWVyU3RhdHVzIGlzIGEgcGVlciBzdGF0dXMuCnR5cGUgUGVlclN0YXR1cyBzdHJpbmcKCmNvbnN0ICgKICAgIFBlZXJTdGF0dXNVcCAgIFBlZXJTdGF0dXMgPSAmcXVvdDt1cCZxdW90OyAgIC8vIENvbm5lY3RlZCBhbmQgcmVhZHkuCiAgICBQZWVyU3RhdHVzRG93biBQZWVyU3RhdHVzID0gJnF1b3Q7ZG93biZxdW90OyAvLyBEaXNjb25uZWN0ZWQuCikKCi8vIFBlZXJVcGRhdGVzIGlzIGEgcmVhbC10aW1lIHBlZXIgdXBkYXRlIHN1YnNjcmlwdGlvbi4KdHlwZSBQZWVyVXBkYXRlcyBzdHJ1Y3QgeyAuLi4gfQoKLy8gVXBkYXRlcyByZXR1cm5zIGEgY2hhbm5lbCBmb3IgY29uc3VtaW5nIHBlZXIgdXBkYXRlcy4KZnVuYyAocHUgKlBlZXJVcGRhdGVzKSBVcGRhdGVzKCkgJmx0Oy1jaGFuIFBlZXJVcGRhdGUKCi8vIENsb3NlIGNsb3NlcyB0aGUgcGVlciB1cGRhdGVzIHN1YnNjcmlwdGlvbi4KZnVuYyAocHUgKlBlZXJVcGRhdGVzKSBDbG9zZSgpCg=="}}),e._v(" "),t("p",[e._v("The "),t("code",[e._v("PeerManager")]),e._v(" will also be responsible for providing peer information to the PEX reactor that can be gossipped to other nodes. This requires an improved system for peer address detection and advertisement, that e.g. reliably detects peer and self addresses and only gossips private network addresses to other peers on the same network, but this system has not yet been fully designed and implemented.")]),e._v(" "),t("h3",{attrs:{id:"channels"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#channels"}},[e._v("#")]),e._v(" Channels")]),e._v(" "),t("p",[e._v("While low-level data exchange happens via the "),t("code",[e._v("Transport")]),e._v(", the high-level API is based on a bidirectional "),t("code",[e._v("Channel")]),e._v(" that can send and receive Protobuf messages addressed by "),t("code",[e._v("NodeID")]),e._v(". A channel is identified by an arbitrary "),t("code",[e._v("ChannelID")]),e._v(" identifier, and can exchange Protobuf messages of one specific type (since the type to unmarshal into must be predefined). Message delivery is asynchronous and at-most-once.")]),e._v(" "),t("p",[e._v("The channel can also be used to report peer errors, e.g. when receiving an invalid or malignant message. This may cause the peer to be disconnected or banned depending on "),t("code",[e._v("PeerManager")]),e._v(" policy, but should probably be replaced by a broader peer behavior API that can also report good behavior.")]),e._v(" "),t("p",[e._v("A "),t("code",[e._v("Channel")]),e._v(" has this interface:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gQ2hhbm5lbElEIGlzIGFuIGFyYml0cmFyeSBjaGFubmVsIElELgp0eXBlIENoYW5uZWxJRCB1aW50MTYKCi8vIENoYW5uZWwgaXMgYSBiaWRpcmVjdGlvbmFsIGNoYW5uZWwgdG8gZXhjaGFuZ2UgUHJvdG9idWYgbWVzc2FnZXMgd2l0aCBwZWVycy4KdHlwZSBDaGFubmVsIHN0cnVjdCB7CiAgICBJRCAgICAgICAgICBDaGFubmVsSUQgICAgICAgIC8vIENoYW5uZWwgSUQuCiAgICBJbiAgICAgICAgICAmbHQ7LWNoYW4gRW52ZWxvcGUgIC8vIEluYm91bmQgbWVzc2FnZXMgKHBlZXJzIHRvIHJlYWN0b3JzKS4KICAgIE91dCAgICAgICAgIGNoYW4mbHQ7LSBFbnZlbG9wZSAgLy8gb3V0Ym91bmQgbWVzc2FnZXMgKHJlYWN0b3JzIHRvIHBlZXJzKQogICAgRXJyb3IgICAgICAgY2hhbiZsdDstIFBlZXJFcnJvciAvLyBQZWVyIGVycm9yIHJlcG9ydGluZy4KICAgIG1lc3NhZ2VUeXBlIHByb3RvLk1lc3NhZ2UgICAgLy8gQ2hhbm5lbCdzIG1lc3NhZ2UgdHlwZSwgZm9yIGUuZy4gdW5tYXJzaGFsbGluZy4KfQoKLy8gQ2xvc2UgY2xvc2VzIHRoZSBjaGFubmVsLCBhbHNvIGNsb3NpbmcgT3V0IGFuZCBFcnJvci4KZnVuYyAoYyAqQ2hhbm5lbCkgQ2xvc2UoKSBlcnJvcgoKLy8gRW52ZWxvcGUgc3BlY2lmaWVzIHRoZSBtZXNzYWdlIHJlY2VpdmVyIGFuZCBzZW5kZXIuCnR5cGUgRW52ZWxvcGUgc3RydWN0IHsKICAgIEZyb20gICAgICBOb2RlSUQgICAgICAgIC8vIFNlbmRlciAoZW1wdHkgaWYgb3V0Ym91bmQpLgogICAgVG8gICAgICAgIE5vZGVJRCAgICAgICAgLy8gUmVjZWl2ZXIgKGVtcHR5IGlmIGluYm91bmQpLgogICAgQnJvYWRjYXN0IGJvb2wgICAgICAgICAgLy8gU2VuZCB0byBhbGwgY29ubmVjdGVkIHBlZXJzLCBpZ25vcmluZyBUby4KICAgIE1lc3NhZ2UgICBwcm90by5NZXNzYWdlIC8vIE1lc3NhZ2UgcGF5bG9hZC4KfQoKLy8gUGVlckVycm9yIGlzIGEgcGVlciBlcnJvciByZXBvcnRlZCB2aWEgdGhlIEVycm9yIGNoYW5uZWwuCnR5cGUgUGVlckVycm9yIHN0cnVjdCB7CiAgICBOb2RlSUQgICBOb2RlSUQKICAgIEVyciAgICAgIGVycm9yCn0K"}}),e._v(" "),t("p",[e._v("A channel can reach any connected peer, and will automatically (un)marshal the Protobuf messages. Message scheduling and queueing is a "),t("code",[e._v("Router")]),e._v(" implementation concern, and can use any number of algorithms such as FIFO, round-robin, priority queues, etc. Since message delivery is not guaranteed, both inbound and outbound messages may be dropped, buffered, reordered, or blocked as appropriate.")]),e._v(" "),t("p",[e._v("Since a channel can only exchange messages of a single type, it is often useful to use a wrapper message type with e.g. a Protobuf "),t("code",[e._v("oneof")]),e._v(" field that specifies a set of inner message types that it can contain. The channel can automatically perform this (un)wrapping if the outer message type implements the "),t("code",[e._v("Wrapper")]),e._v(" interface (see "),t("a",{attrs:{href:"#reactor-example"}},[e._v("Reactor Example")]),e._v(" for an example):")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gV3JhcHBlciBpcyBhIFByb3RvYnVmIG1lc3NhZ2UgdGhhdCBjYW4gY29udGFpbiBhIHZhcmlldHkgb2YgaW5uZXIgbWVzc2FnZXMuCi8vIElmIGEgQ2hhbm5lbCdzIG1lc3NhZ2UgdHlwZSBpbXBsZW1lbnRzIFdyYXBwZXIsIHRoZSBjaGFubmVsIHdpbGwKLy8gYXV0b21hdGljYWxseSAodW4pd3JhcCBwYXNzZWQgbWVzc2FnZXMgdXNpbmcgdGhlIGNvbnRhaW5lciB0eXBlLCBzdWNoIHRoYXQKLy8gdGhlIGNoYW5uZWwgY2FuIHRyYW5zcGFyZW50bHkgc3VwcG9ydCBtdWx0aXBsZSBtZXNzYWdlIHR5cGVzLgp0eXBlIFdyYXBwZXIgaW50ZXJmYWNlIHsKICAgIHByb3RvLk1lc3NhZ2UKCiAgICAvLyBXcmFwIHdpbGwgdGFrZSBhIG1lc3NhZ2UgYW5kIHdyYXAgaXQgaW4gdGhpcyBvbmUuCiAgICBXcmFwKHByb3RvLk1lc3NhZ2UpIGVycm9yCgogICAgLy8gVW53cmFwIHdpbGwgdW53cmFwIHRoZSBpbm5lciBtZXNzYWdlIGNvbnRhaW5lZCBpbiB0aGlzIG1lc3NhZ2UuCiAgICBVbndyYXAoKSAocHJvdG8uTWVzc2FnZSwgZXJyb3IpCn0K"}}),e._v(" "),t("h3",{attrs:{id:"routers"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#routers"}},[e._v("#")]),e._v(" Routers")]),e._v(" "),t("p",[e._v("The router exeutes P2P networking for a node, taking instructions from and reporting events to the "),t("code",[e._v("PeerManager")]),e._v(", maintaining transport connections to peers, and routing messages between channels and peers.")]),e._v(" "),t("p",[e._v("Practically all concurrency in the P2P stack has been moved into the router and reactors, while as many other responsibilities as possible have been moved into separate components such as the "),t("code",[e._v("Transport")]),e._v(" and "),t("code",[e._v("PeerManager")]),e._v(" that can remain largely synchronous. Limiting concurrency to a single core component makes it much easier to reason about since there is only a single concurrency structure, while the remaining components can be serial, simple, and easily testable.")]),e._v(" "),t("p",[e._v("The "),t("code",[e._v("Router")]),e._v(" has a very minimal API, since it is mostly driven by "),t("code",[e._v("PeerManager")]),e._v(" and "),t("code",[e._v("Transport")]),e._v(" events:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gUm91dGVyIG1haW50YWlucyBwZWVyIHRyYW5zcG9ydCBjb25uZWN0aW9ucyBhbmQgcm91dGVzIG1lc3NhZ2VzIGJldHdlZW4KLy8gcGVlcnMgYW5kIGNoYW5uZWxzLgp0eXBlIFJvdXRlciBzdHJ1Y3QgewogICAgLy8gU29tZSBkZXRhaWxzIGhhdmUgYmVlbiBvbWl0dGVkIGJlbG93LgoKICAgIGxvZ2dlciAgICAgICAgICBsb2cuTG9nZ2VyCiAgICBvcHRpb25zICAgICAgICAgUm91dGVyT3B0aW9ucwogICAgbm9kZUluZm8gICAgICAgIE5vZGVJbmZvCiAgICBwcml2S2V5ICAgICAgICAgY3J5cHRvLlByaXZLZXkKICAgIHBlZXJNYW5hZ2VyICAgICAqUGVlck1hbmFnZXIKICAgIHRyYW5zcG9ydHMgICAgICBbXVRyYW5zcG9ydAoKICAgIHBlZXJNdHggICAgICAgICBzeW5jLlJXTXV0ZXgKICAgIHBlZXJRdWV1ZXMgICAgICBtYXBbTm9kZUlEXXF1ZXVlCgogICAgY2hhbm5lbE10eCAgICAgIHN5bmMuUldNdXRleAogICAgY2hhbm5lbFF1ZXVlcyAgIG1hcFtDaGFubmVsSURdcXVldWUKfQoKLy8gT3BlbkNoYW5uZWwgb3BlbnMgYSBuZXcgY2hhbm5lbCBmb3IgdGhlIGdpdmVuIG1lc3NhZ2UgdHlwZS4gVGhlIGNhbGxlciBtdXN0Ci8vIGNsb3NlIHRoZSBjaGFubmVsIHdoZW4gZG9uZSwgYmVmb3JlIHN0b3BwaW5nIHRoZSBSb3V0ZXIuIG1lc3NhZ2VUeXBlIGlzIHRoZQovLyB0eXBlIG9mIG1lc3NhZ2UgcGFzc2VkIHRocm91Z2ggdGhlIGNoYW5uZWwuCmZ1bmMgKHIgKlJvdXRlcikgT3BlbkNoYW5uZWwoaWQgQ2hhbm5lbElELCBtZXNzYWdlVHlwZSBwcm90by5NZXNzYWdlKSAoKkNoYW5uZWwsIGVycm9yKQoKLy8gU3RhcnQgc3RhcnRzIHRoZSByb3V0ZXIsIGNvbm5lY3RpbmcgdG8gcGVlcnMgYW5kIHJvdXRpbmcgbWVzc2FnZXMuCmZ1bmMgKHIgKlJvdXRlcikgU3RhcnQoKSBlcnJvcgoKLy8gU3RvcCBzdG9wcyB0aGUgcm91dGVyLCBkaXNjb25uZWN0aW5nIGZyb20gYWxsIHBlZXJzIGFuZCBzdG9wcGluZyBtZXNzYWdlIHJvdXRpbmcuCmZ1bmMgKHIgKlJvdXRlcikgU3RvcCgpIGVycm9yCg=="}}),e._v(" "),t("p",[e._v("All Go channel sends in the "),t("code",[e._v("Router")]),e._v(" and reactors are blocking (the router also selects on signal channels for closure and shutdown). The responsibility for message scheduling, prioritization, backpressure, and load shedding is centralized in a core "),t("code",[e._v("queue")]),e._v(" interface that is used at contention points (i.e. from all peers to a single channel, and from all channels to a single peer):")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gcXVldWUgZG9lcyBRb1Mgc2NoZWR1bGluZyBmb3IgRW52ZWxvcGVzLCBlbnF1ZXVlaW5nIGFuZCBkZXF1ZXVlaW5nIGFjY29yZGluZwovLyB0byBzb21lIHBvbGljeS4gUXVldWVzIGFyZSB1c2VkIGF0IGNvbnRlbnRpb24gcG9pbnRzLCBpLmUuOgovLyAtIFJlY2VpdmluZyBpbmJvdW5kIG1lc3NhZ2VzIHRvIGEgc2luZ2xlIGNoYW5uZWwgZnJvbSBhbGwgcGVlcnMuCi8vIC0gU2VuZGluZyBvdXRib3VuZCBtZXNzYWdlcyB0byBhIHNpbmdsZSBwZWVyIGZyb20gYWxsIGNoYW5uZWxzLgp0eXBlIHF1ZXVlIGludGVyZmFjZSB7CiAgICAvLyBlbnF1ZXVlIHJldHVybnMgYSBjaGFubmVsIGZvciBzdWJtaXR0aW5nIGVudmVsb3Blcy4KICAgIGVucXVldWUoKSBjaGFuJmx0Oy0gRW52ZWxvcGUKCiAgICAvLyBkZXF1ZXVlIHJldHVybnMgYSBjaGFubmVsIG9yZGVyZWQgYWNjb3JkaW5nIHRvIHNvbWUgcXVldWVpbmcgcG9saWN5LgogICAgZGVxdWV1ZSgpICZsdDstY2hhbiBFbnZlbG9wZQoKICAgIC8vIGNsb3NlIGNsb3NlcyB0aGUgcXVldWUuIEFmdGVyIHRoaXMgY2FsbCBlbnF1ZXVlKCkgd2lsbCBibG9jaywgc28gdGhlCiAgICAvLyBjYWxsZXIgbXVzdCBzZWxlY3Qgb24gY2xvc2VkKCkgYXMgd2VsbCB0byBhdm9pZCBibG9ja2luZyBmb3JldmVyLiBUaGUKICAgIC8vIGVucXVldWUoKSBhbmQgZGVxdWV1ZSgpIGNoYW5uZWxzIHdpbGwgbm90IGJlIGNsb3NlZC4KICAgIGNsb3NlKCkKCiAgICAvLyBjbG9zZWQgcmV0dXJucyBhIGNoYW5uZWwgdGhhdCdzIGNsb3NlZCB3aGVuIHRoZSBzY2hlZHVsZXIgaXMgY2xvc2VkLgogICAgY2xvc2VkKCkgJmx0Oy1jaGFuIHN0cnVjdHt9Cn0K"}}),e._v(" "),t("p",[e._v("The current implementation is "),t("code",[e._v("fifoQueue")]),e._v(", which is a simple unbuffered lossless queue that passes messages in the order they were received and blocks until the message is delivered (i.e. it is a Go channel). The router will need a more sophisticated queueing policy, but this has not yet been implemented.")]),e._v(" "),t("p",[e._v("The internal "),t("code",[e._v("Router")]),e._v(" goroutine structure and design is described in the "),t("code",[e._v("Router")]),e._v(" GoDoc, which is included below for reference:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gT24gc3RhcnR1cCwgdGhyZWUgbWFpbiBnb3JvdXRpbmVzIGFyZSBzcGF3bmVkIHRvIG1haW50YWluIHBlZXIgY29ubmVjdGlvbnM6Ci8vCi8vICAgZGlhbFBlZXJzKCk6IGluIGEgbG9vcCwgY2FsbHMgUGVlck1hbmFnZXIuRGlhbE5leHQoKSB0byBnZXQgdGhlIG5leHQgcGVlcgovLyAgIGFkZHJlc3MgdG8gZGlhbCBhbmQgc3Bhd25zIGEgZ29yb3V0aW5lIHRoYXQgZGlhbHMgdGhlIHBlZXIsIGhhbmRzaGFrZXMKLy8gICB3aXRoIGl0LCBhbmQgYmVnaW5zIHRvIHJvdXRlIG1lc3NhZ2VzIGlmIHN1Y2Nlc3NmdWwuCi8vCi8vICAgYWNjZXB0UGVlcnMoKTogaW4gYSBsb29wLCB3YWl0cyBmb3IgYW4gaW5ib3VuZCBjb25uZWN0aW9uIHZpYQovLyAgIFRyYW5zcG9ydC5BY2NlcHQoKSBhbmQgc3Bhd25zIGEgZ29yb3V0aW5lIHRoYXQgaGFuZHNoYWtlcyB3aXRoIGl0IGFuZAovLyAgIGJlZ2lucyB0byByb3V0ZSBtZXNzYWdlcyBpZiBzdWNjZXNzZnVsLgovLwovLyAgIGV2aWN0UGVlcnMoKTogaW4gYSBsb29wLCBjYWxscyBQZWVyTWFuYWdlci5FdmljdE5leHQoKSB0byBnZXQgdGhlIG5leHQKLy8gICBwZWVyIHRvIGV2aWN0LCBhbmQgZGlzY29ubmVjdHMgaXQgYnkgY2xvc2luZyBpdHMgbWVzc2FnZSBxdWV1ZS4KLy8KLy8gV2hlbiBhIHBlZXIgaXMgY29ubmVjdGVkLCBhbiBvdXRib3VuZCBwZWVyIG1lc3NhZ2UgcXVldWUgaXMgcmVnaXN0ZXJlZCBpbgovLyBwZWVyUXVldWVzLCBhbmQgcm91dGVQZWVyKCkgaXMgY2FsbGVkIHRvIHNwYXduIG9mZiB0d28gYWRkaXRpb25hbCBnb3JvdXRpbmVzOgovLwovLyAgIHNlbmRQZWVyKCk6IHdhaXRzIGZvciBhbiBvdXRib3VuZCBtZXNzYWdlIGZyb20gdGhlIHBlZXJRdWV1ZXMgcXVldWUsCi8vICAgbWFyc2hhbHMgaXQsIGFuZCBwYXNzZXMgaXQgdG8gdGhlIHBlZXIgdHJhbnNwb3J0IHdoaWNoIGRlbGl2ZXJzIGl0LgovLwovLyAgIHJlY2VpdmVQZWVyKCk6IHdhaXRzIGZvciBhbiBpbmJvdW5kIG1lc3NhZ2UgZnJvbSB0aGUgcGVlciB0cmFuc3BvcnQsCi8vICAgdW5tYXJzaGFscyBpdCwgYW5kIHBhc3NlcyBpdCB0byB0aGUgYXBwcm9wcmlhdGUgaW5ib3VuZCBjaGFubmVsIHF1ZXVlCi8vICAgaW4gY2hhbm5lbFF1ZXVlcy4KLy8KLy8gV2hlbiBhIHJlYWN0b3Igb3BlbnMgYSBjaGFubmVsIHZpYSBPcGVuQ2hhbm5lbCwgYW4gaW5ib3VuZCBjaGFubmVsIG1lc3NhZ2UKLy8gcXVldWUgaXMgcmVnaXN0ZXJlZCBpbiBjaGFubmVsUXVldWVzLCBhbmQgYSBjaGFubmVsIGdvcm91dGluZSBpcyBzcGF3bmVkOgovLwovLyAgIHJvdXRlQ2hhbm5lbCgpOiB3YWl0cyBmb3IgYW4gb3V0Ym91bmQgbWVzc2FnZSBmcm9tIHRoZSBjaGFubmVsLCBsb29rcwovLyAgIHVwIHRoZSByZWNpcGllbnQgcGVlcidzIG91dGJvdW5kIG1lc3NhZ2UgcXVldWUgaW4gcGVlclF1ZXVlcywgYW5kIHN1Ym1pdHMKLy8gICB0aGUgbWVzc2FnZSB0byBpdC4KLy8KLy8gQWxsIGNoYW5uZWwgc2VuZHMgaW4gdGhlIHJvdXRlciBhcmUgYmxvY2tpbmcuIEl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUKLy8gcXVldWUgaW50ZXJmYWNlIGluIHBlZXJRdWV1ZXMgYW5kIGNoYW5uZWxRdWV1ZXMgdG8gcHJpb3JpdGl6ZSBhbmQgZHJvcAovLyBtZXNzYWdlcyBhcyBhcHByb3ByaWF0ZSBkdXJpbmcgY29udGVudGlvbiB0byBwcmV2ZW50IHN0YWxscyBhbmQgZW5zdXJlIGdvb2QKLy8gcXVhbGl0eSBvZiBzZXJ2aWNlLgo="}}),e._v(" "),t("h3",{attrs:{id:"reactor-example"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#reactor-example"}},[e._v("#")]),e._v(" Reactor Example")]),e._v(" "),t("p",[e._v("While reactors are a first-class concept in the current P2P stack (i.e. there is an explicit "),t("code",[e._v("p2p.Reactor")]),e._v(' interface), they will simply be a design pattern in the new stack, loosely defined as "something which listens on a channel and reacts to messages".')]),e._v(" "),t("p",[e._v("Since reactors have very few formal constraints, they can be implemented in a variety of ways. There is currently no recommended pattern for implementing reactors, to avoid overspecification and scope creep in this ADR. However, prototyping and developing a reactor pattern should be done early during implementation, to make sure reactors built using the "),t("code",[e._v("Channel")]),e._v(" interface can satisfy the needs for convenience, deterministic tests, and reliability.")]),e._v(" "),t("p",[e._v("Below is a trivial example of a simple echo reactor implemented as a function. The reactor will exchange the following Protobuf messages:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"protobuf",base64:"bWVzc2FnZSBFY2hvTWVzc2FnZSB7CiAgICBvbmVvZiBpbm5lciB7CiAgICAgICAgUGluZ01lc3NhZ2UgcGluZyA9IDE7CiAgICAgICAgUG9uZ01lc3NhZ2UgcG9uZyA9IDI7CiAgICB9Cn0KCm1lc3NhZ2UgUGluZ01lc3NhZ2UgewogICAgc3RyaW5nIGNvbnRlbnQgPSAxOwp9CgptZXNzYWdlIFBvbmdNZXNzYWdlIHsKICAgIHN0cmluZyBjb250ZW50ID0gMTsKfQo="}}),e._v(" "),t("p",[e._v("Implementing the "),t("code",[e._v("Wrapper")]),e._v(" interface for "),t("code",[e._v("EchoMessage")]),e._v(" allows transparently passing "),t("code",[e._v("PingMessage")]),e._v(" and "),t("code",[e._v("PongMessage")]),e._v(" through the channel, where it will automatically be (un)wrapped in an "),t("code",[e._v("EchoMessage")]),e._v(":")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAobSAqRWNob01lc3NhZ2UpIFdyYXAoaW5uZXIgcHJvdG8uTWVzc2FnZSkgZXJyb3IgewogICAgc3dpdGNoIGlubmVyIDo9IGlubmVyLih0eXBlKSB7CiAgICBjYXNlICpQaW5nTWVzc2FnZToKICAgICAgICBtLklubmVyID0gJmFtcDtFY2hvTWVzc2FnZV9QaW5nTWVzc2FnZXtQaW5nOiBpbm5lcn0KICAgIGNhc2UgKlBvbmdNZXNzYWdlOgogICAgICAgIG0uSW5uZXIgPSAmYW1wO0VjaG9NZXNzYWdlX1BvbmdNZXNzYWdle1Bvbmc6IGlubmVyfQogICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gZm10LkVycm9yZigmcXVvdDt1bmtub3duIG1lc3NhZ2UgJVQmcXVvdDssIGlubmVyKQogICAgfQogICAgcmV0dXJuIG5pbAp9CgpmdW5jIChtICpFY2hvTWVzc2FnZSkgVW53cmFwKCkgKHByb3RvLk1lc3NhZ2UsIGVycm9yKSB7CiAgICBzd2l0Y2ggaW5uZXIgOj0gbS5Jbm5lci4odHlwZSkgewogICAgY2FzZSAqRWNob01lc3NhZ2VfUGluZ01lc3NhZ2U6CiAgICAgICAgcmV0dXJuIGlubmVyLlBpbmcsIG5pbAogICAgY2FzZSAqRWNob01lc3NhZ2VfUG9uZ01lc3NhZ2U6CiAgICAgICAgcmV0dXJuIGlubmVyLlBvbmcsIG5pbAogICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gbmlsLCBmbXQuRXJyb3JmKCZxdW90O3Vua25vd24gbWVzc2FnZSAlVCZxdW90OywgaW5uZXIpCiAgICB9Cn0K"}}),e._v(" "),t("p",[e._v("The reactor itself would be implemented e.g. like this:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gUnVuRWNob1JlYWN0b3Igd2lyZXMgdXAgYW4gZWNobyByZWFjdG9yIHRvIGEgcm91dGVyIGFuZCBydW5zIGl0LgpmdW5jIFJ1bkVjaG9SZWFjdG9yKHJvdXRlciAqcDJwLlJvdXRlciwgcGVlck1hbmFnZXIgKnAycC5QZWVyTWFuYWdlcikgZXJyb3IgewogICAgY2hhbm5lbCwgZXJyIDo9IHJvdXRlci5PcGVuQ2hhbm5lbCgxLCAmYW1wO0VjaG9NZXNzYWdle30pCiAgICBpZiBlcnIgIT0gbmlsIHsKICAgICAgICByZXR1cm4gZXJyCiAgICB9CiAgICBkZWZlciBjaGFubmVsLkNsb3NlKCkKICAgIHBlZXJVcGRhdGVzIDo9IHBlZXJNYW5hZ2VyLlN1YnNjcmliZSgpCiAgICBkZWZlciBwZWVyVXBkYXRlcy5DbG9zZSgpCgogICAgcmV0dXJuIEVjaG9SZWFjdG9yKGNvbnRleHQuQmFja2dyb3VuZCgpLCBjaGFubmVsLCBwZWVyVXBkYXRlcykKfQoKLy8gRWNob1JlYWN0b3IgcHJvdmlkZXMgYW4gZWNobyBzZXJ2aWNlLCBwaW5naW5nIGFsbCBrbm93biBwZWVycyB1bnRpbCB0aGUgZ2l2ZW4KLy8gY29udGV4dCBpcyBjYW5jZWxsZWQuCmZ1bmMgRWNob1JlYWN0b3IoY3R4IGNvbnRleHQuQ29udGV4dCwgY2hhbm5lbCAqcDJwLkNoYW5uZWwsIHBlZXJVcGRhdGVzICpwMnAuUGVlclVwZGF0ZXMpIGVycm9yIHsKICAgIHRpY2tlciA6PSB0aW1lLk5ld1RpY2tlcig1ICogdGltZS5TZWNvbmQpCiAgICBkZWZlciB0aWNrZXIuU3RvcCgpCgogICAgZm9yIHsKICAgICAgICBzZWxlY3QgewogICAgICAgIC8vIFNlbmQgcGluZyBtZXNzYWdlIHRvIGFsbCBrbm93biBwZWVycyBldmVyeSA1IHNlY29uZHMuCiAgICAgICAgY2FzZSAmbHQ7LXRpY2tlci5DOgogICAgICAgICAgICBjaGFubmVsLk91dCAmbHQ7LSBFbnZlbG9wZXsKICAgICAgICAgICAgICAgIEJyb2FkY2FzdDogdHJ1ZSwKICAgICAgICAgICAgICAgIE1lc3NhZ2U6ICAgJmFtcDtQaW5nTWVzc2FnZXtDb250ZW50OiAmcXVvdDvwn5GLJnF1b3Q7fSwKICAgICAgICAgICAgfQoKICAgICAgICAvLyBXaGVuIHdlIHJlY2VpdmUgYSBtZXNzYWdlIGZyb20gYSBwZWVyLCBlaXRoZXIgcmVzcG9uZCB0byBwaW5nLCBvdXRwdXQKICAgICAgICAvLyBwb25nLCBvciByZXBvcnQgcGVlciBlcnJvciBvbiB1bmtub3duIG1lc3NhZ2UgdHlwZS4KICAgICAgICBjYXNlIGVudmVsb3BlIDo9ICZsdDstY2hhbm5lbC5JbjoKICAgICAgICAgICAgc3dpdGNoIG1zZyA6PSBlbnZlbG9wZS5NZXNzYWdlLih0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgKlBpbmdNZXNzYWdlOgogICAgICAgICAgICAgICAgY2hhbm5lbC5PdXQgJmx0Oy0gRW52ZWxvcGV7CiAgICAgICAgICAgICAgICAgICAgVG86ICAgICAgZW52ZWxvcGUuRnJvbSwKICAgICAgICAgICAgICAgICAgICBNZXNzYWdlOiAmYW1wO1BvbmdNZXNzYWdle0NvbnRlbnQ6IG1zZy5Db250ZW50fSwKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNhc2UgKlBvbmdNZXNzYWdlOgogICAgICAgICAgICAgICAgZm10LlByaW50ZigmcXVvdDslcSByZXBsaWVkIHdpdGggJXFcbiZxdW90OywgZW52ZWxvcGUuRnJvbSwgbXNnLkNvbnRlbnQpCgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgY2hhbm5lbC5FcnJvciAmbHQ7LSBQZWVyRXJyb3J7CiAgICAgICAgICAgICAgICAgICAgUGVlcklEOiBlbnZlbG9wZS5Gcm9tLAogICAgICAgICAgICAgICAgICAgIEVycjogICAgZm10LkVycm9yZigmcXVvdDt1bmV4cGVjdGVkIG1lc3NhZ2UgJVQmcXVvdDssIG1zZyksCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgLy8gT3V0cHV0IGluZm8gYWJvdXQgYW55IHBlZXIgc3RhdHVzIGNoYW5nZXMuCiAgICAgICAgY2FzZSBwZWVyVXBkYXRlIDo9ICZsdDstcGVlclVwZGF0ZXM6CiAgICAgICAgICAgIGZtdC5QcmludGYoJnF1b3Q7UGVlciAlcSBjaGFuZ2VkIHN0YXR1cyB0byAlcSZxdW90OywgcGVlclVwZGF0ZS5QZWVySUQsIHBlZXJVcGRhdGUuU3RhdHVzKQoKICAgICAgICAvLyBFeGl0IHdoZW4gY29udGV4dCBpcyBjYW5jZWxsZWQuCiAgICAgICAgY2FzZSAmbHQ7LWN0eC5Eb25lKCk6CiAgICAgICAgICAgIHJldHVybiBuaWwKICAgICAgICB9CiAgICB9Cn0K"}}),e._v(" "),t("h2",{attrs:{id:"status"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#status"}},[e._v("#")]),e._v(" Status")]),e._v(" "),t("p",[e._v("Partially implemented ("),t("a",{attrs:{href:"https://github.com/tendermint/tendermint/issues/5670",target:"_blank",rel:"noopener noreferrer"}},[e._v("#5670"),t("OutboundLink")],1),e._v(")")]),e._v(" "),t("h2",{attrs:{id:"consequences"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#consequences"}},[e._v("#")]),e._v(" Consequences")]),e._v(" "),t("h3",{attrs:{id:"positive"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#positive"}},[e._v("#")]),e._v(" Positive")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("Reduced coupling and simplified interfaces should lead to better understandability, increased reliability, and more testing.")])]),e._v(" "),t("li",[t("p",[e._v("Using message passing via Go channels gives better control of backpressure and quality-of-service scheduling.")])]),e._v(" "),t("li",[t("p",[e._v("Peer lifecycle and connection management is centralized in a single entity, making it easier to reason about.")])]),e._v(" "),t("li",[t("p",[e._v("Detection, advertisement, and exchange of node addresses will be improved.")])]),e._v(" "),t("li",[t("p",[e._v("Additional transports (e.g. QUIC) can be implemented and used in parallel with the existing MConn protocol.")])]),e._v(" "),t("li",[t("p",[e._v("The P2P protocol will not be broken in the initial version, if possible.")])])]),e._v(" "),t("h3",{attrs:{id:"negative"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#negative"}},[e._v("#")]),e._v(" Negative")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("Fully implementing the new design as indended is likely to require breaking changes to the P2P protocol at some point, although the initial implementation shouldn't.")])]),e._v(" "),t("li",[t("p",[e._v("Gradually migrating the existing stack and maintaining backwards-compatibility will be more labor-intensive than simply replacing the entire stack.")])]),e._v(" "),t("li",[t("p",[e._v("A complete overhaul of P2P internals is likely to cause temporary performance regressions and bugs as the implementation matures.")])]),e._v(" "),t("li",[t("p",[e._v("Hiding peer management information inside the "),t("code",[e._v("PeerManager")]),e._v(" may prevent certain functionality or require additional deliberate interfaces for information exchange, as a tradeoff to simplify the design, reduce coupling, and avoid race conditions and lock contention.")])])]),e._v(" "),t("h3",{attrs:{id:"neutral"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#neutral"}},[e._v("#")]),e._v(" Neutral")]),e._v(" "),t("ul",[t("li",[e._v("Implementation details around e.g. peer management, message scheduling, and peer and endpoint advertisement are not yet determined.")])]),e._v(" "),t("h2",{attrs:{id:"references"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[e._v("#")]),e._v(" References")]),e._v(" "),t("ul",[t("li",[t("RouterLink",{attrs:{to:"/architecture/adr-061-p2p-refactor-scope.html"}},[e._v("ADR 061: P2P Refactor Scope")])],1),e._v(" "),t("li",[t("a",{attrs:{href:"https://github.com/tendermint/tendermint/issues/5670",target:"_blank",rel:"noopener noreferrer"}},[e._v("#5670 p2p: internal refactor and architecture redesign"),t("OutboundLink")],1)])])],1)}),[],!1,null,null,null);a.default=o.exports}}]);